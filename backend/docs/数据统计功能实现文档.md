# 数据统计功能实现文档

## 1. 功能概述

数据统计功能是兴趣追踪系统的核心模块，提供了全面的数据分析和可视化展示能力。该功能包括：

- **统计概览**：展示各类兴趣记录的总数、新增数量、趋势等
- **数据洞察**：提供智能化的数据分析，包括最活跃类型、评分趋势、活跃度峰值、完成率等
- **时间范围切换**：支持今日、本周、本月、本年以及自定义时间范围的统计查询
- **趋势图表**：展示最近N天的数据趋势折线图
- **最近活动**：展示用户最近的记录活动

## 2. 技术架构

### 2.1 后端技术栈
- **框架**：Spring Boot
- **ORM**：MyBatis Plus
- **数据转换**：BeanUtils
- **时间处理**：Java 8 Time API (LocalDateTime, LocalDate)

### 2.2 前端技术栈
- **框架**：Vue 3 + TypeScript
- **状态管理**：Pinia
- **UI组件库**：Element Plus
- **图表库**：ECharts
- **样式**：Tailwind CSS

## 3. 后端实现

### 3.1 API接口

#### 3.1.1 统计概览接口
```
GET /api/dashboard/summary
```

**请求参数** (`DashboardSummaryReqVO`)：
- `timeRange`：时间范围类型（today/week/month/year/custom）
- `startDate`：自定义开始日期（当timeRange为custom时必填）
- `endDate`：自定义结束日期（当timeRange为custom时必填）

**响应数据** (`DashboardSummaryRespVO`)：
- `photoCount`：照片总数
- `movieCount`：影视总数
- `musicCount`：音乐总数
- `bookCount`：阅读总数
- `travelCount`：旅游总数
- `concertCount`：演唱会总数
- `matchCount`：球赛总数
- `weeklyStats`：当前时间范围新增统计
- `lastWeekStats`：上一时间范围新增统计（用于计算增长率）
- `monthlyStats`：本月新增统计
- `todayStats`：今日新增统计
- `movieStatusCounts`：影视状态统计
- `musicStatusCounts`：音乐状态统计
- `bookStatusCounts`：阅读状态统计
- `trendData`：趋势数据（包含日期列表和各类型每日新增数量）

#### 3.1.2 数据洞察接口
```
GET /api/dashboard/insights
```

**请求参数**：同统计概览接口

**响应数据** (`InsightsRespVO`)：
- `mostActiveType`：最活跃类型
  - `type`：类型标识
  - `typeName`：类型中文名称
  - `count`：新增数量
  - `percentage`：占比（百分比）
- `ratingTrend`：评分趋势
  - `currentAvgRating`：当前平均评分
  - `previousAvgRating`：上期平均评分
  - `changePercentage`：变化百分比
  - `trend`：趋势（up/down/stable）
- `peakActivity`：活跃度峰值
  - `date`：峰值日期
  - `count`：峰值数量
  - `type`：峰值类型
  - `typeName`：类型中文名称
- `completionRate`：完成率
  - `completed`：已完成数量
  - `total`：总计划数量
  - `percentage`：完成率（百分比）
  - `type`：类型（movie/music/book）
  - `typeName`：类型中文名称

#### 3.1.3 最近活动接口
```
GET /api/dashboard/recent-activities?limit=10
```

**响应数据** (`RecentActivityRespVO[]`)：
- `id`：活动ID
- `type`：活动类型
- `title`：活动标题
- `description`：活动描述（评论）
- `cover`：封面图片URL
- `activityTime`：活动时间
- `tags`：标签
- `rating`：评分
- `status`：状态
- `subtitle`：副标题

### 3.2 核心实现逻辑

#### 3.2.1 时间范围计算

系统支持5种时间范围类型：

1. **今日** (today)
   - 当前范围：今天 00:00:00 - 现在
   - 上一范围：昨天 00:00:00 - 今天 00:00:00
   - 趋势天数：1天

2. **本周** (week)
   - 当前范围：7天前 00:00:00 - 现在
   - 上一范围：14天前 00:00:00 - 7天前 00:00:00
   - 趋势天数：7天

3. **本月** (month)
   - 当前范围：1个月前 00:00:00 - 现在
   - 上一范围：2个月前 00:00:00 - 1个月前 00:00:00
   - 趋势天数：30天

4. **本年** (year)
   - 当前范围：1年前 00:00:00 - 现在
   - 上一范围：2年前 00:00:00 - 1年前 00:00:00
   - 趋势天数：365天

5. **自定义** (custom)
   - 当前范围：用户指定的开始日期 - 结束日期
   - 上一范围：自动计算相同长度的时间段
   - 趋势天数：根据时间范围计算（最多90天）

#### 3.2.2 数据统计方法

所有统计方法都基于**实际活动日期**而非记录创建时间：

- `countMovieRecords`：使用 `watchDate` 字段
- `countAlbumRecords`：使用 `listenDate` 字段
- `countBookRecords`：使用 `readDate` 字段
- `countTravelRecords`：使用 `travelDate` 字段
- `countConcertRecords`：使用 `watchDate` 字段
- `countMatchRecords`：使用 `matchDate` 字段
- `countPhotos`：使用 `createTime` 字段（照片没有活动日期字段）

#### 3.2.3 趋势数据生成

`getTrendData` 方法按天统计最近N天的数据：
- 生成日期列表（格式：MM-dd）
- 统计每天各类型的新增数量
- 返回结构化的趋势数据供前端图表使用

#### 3.2.4 数据洞察计算

1. **最活跃类型**：
   - 统计各类型在当前时间范围内的新增数量
   - 找出数量最多的类型
   - 计算占比百分比

2. **评分趋势**：
   - 统计当前时间范围内有评分的记录（影视、音乐、阅读）
   - 计算平均评分
   - 与上一时间范围对比，计算变化百分比
   - 判断趋势（上升/下降/稳定）

3. **活跃度峰值**：
   - 按天统计活动数量
   - 找出活动数量最多的日期
   - 识别当天最主要的类型

4. **完成率**：
   - 优先统计影视完成率（已看/总数）
   - 如果没有影视记录，统计音乐完成率
   - 如果都没有，统计阅读完成率

### 3.3 关键代码位置

- **Controller**：`DashboardAppController.java`
- **Service接口**：`DashboardService.java`
- **Service实现**：`DashboardServiceImpl.java`
- **VO类**：
  - `DashboardSummaryReqVO.java`
  - `DashboardSummaryRespVO.java`
  - `InsightsRespVO.java`
  - `RecentActivityRespVO.java`

## 4. 前端实现

### 4.1 页面组件

#### 4.1.1 Dashboard主页面
**文件**：`frontend/src/views/Dashboard.vue`

**主要功能**：
- 展示统计卡片（7个类型：照片、影视、音乐、阅读、旅游、演唱会、球赛）
- 展示数据洞察卡片（4个洞察：最活跃类型、平均评分、活跃度峰值、完成率）
- 展示最近活动列表
- 时间范围切换器

**统计卡片展示内容**：
- 总数
- 当前时间范围新增数量
- 较上周增长率（带趋势箭头）
- 上周新增数量
- 今日新增数量
- 迷你趋势折线图（最近N天）

#### 4.1.2 时间范围切换器组件
**文件**：`frontend/src/components/dashboard/TimeRangeSelector.vue`

**功能**：
- 提供4个选项：今日、本周、本月、本年
- 切换时自动刷新统计数据
- 响应式设计，适配移动端

#### 4.1.3 数据洞察卡片组件
**文件**：`frontend/src/components/dashboard/InsightsCard.vue`

**功能**：
- 可复用的洞察卡片组件
- 支持标题、图标、数值、单位、描述、趋势显示
- 支持加载状态和空数据状态

#### 4.1.4 迷你趋势图表组件
**文件**：`frontend/src/components/charts/MiniTrendChart.vue`

**功能**：
- 使用ECharts渲染迷你折线图
- 支持自定义颜色
- 自动适配数据范围
- 深色主题

### 4.2 API调用

**文件**：`frontend/src/api/dashboard.ts`

**主要方法**：
- `getDashboardSummary(params)`：获取统计概览
- `getDashboardInsights(params)`：获取数据洞察
- `getRecentActivities(limit)`：获取最近活动
- `getTimeline(params)`：获取时间线数据

### 4.3 类型定义

**文件**：`frontend/src/types/api.ts`

定义了完整的TypeScript接口：
- `DashboardSummary`：统计概览数据结构
- `Insights`：数据洞察数据结构
- `RecentActivity`：最近活动数据结构

## 5. 数据流程

### 5.1 统计概览数据流程

```
用户选择时间范围
    ↓
前端调用 getDashboardSummary(timeRange)
    ↓
后端 DashboardService.getSummary(reqVO)
    ↓
计算时间范围（当前范围 + 上一范围）
    ↓
统计各类型数据（总数、当前范围新增、上一范围新增、本月新增、今日新增）
    ↓
获取状态统计（影视、音乐、阅读）
    ↓
生成趋势数据（最近N天）
    ↓
返回 DashboardSummaryRespVO
    ↓
前端渲染统计卡片和趋势图
```

### 5.2 数据洞察数据流程

```
用户选择时间范围
    ↓
前端调用 getDashboardInsights(timeRange)
    ↓
后端 DashboardService.getInsights(reqVO)
    ↓
计算时间范围
    ↓
计算最活跃类型（统计各类型数量，找出最大值）
    ↓
计算评分趋势（统计有评分的记录，计算平均分和变化）
    ↓
计算活跃度峰值（按天统计，找出峰值日期）
    ↓
计算完成率（统计已完成/总数）
    ↓
返回 InsightsRespVO
    ↓
前端渲染洞察卡片
```

## 6. 核心特性

### 6.1 基于实际活动日期的统计

**重要**：所有统计都基于实际活动日期，而非记录创建时间：
- 影视记录：使用 `watchDate`（观看日期）
- 音乐记录：使用 `listenDate`（收听日期）
- 阅读记录：使用 `readDate`（阅读日期）
- 旅游记录：使用 `travelDate`（旅游日期）
- 演唱会记录：使用 `watchDate`（观演日期）
- 球赛记录：使用 `matchDate`（比赛日期）

这确保了统计数据反映的是用户实际的活动时间，而不是记录添加时间。

### 6.2 动态时间范围支持

系统支持灵活的时间范围查询：
- 预设范围：今日、本周、本月、本年
- 自定义范围：用户可指定开始和结束日期
- 自动计算上一时间段：用于对比和增长率计算

### 6.3 趋势可视化

- 迷你折线图：在每个统计卡片底部展示最近N天的趋势
- 动态天数：根据时间范围自动调整趋势图天数
- 多类型支持：每个类型都有独立的趋势数据

### 6.4 智能数据洞察

- **最活跃类型**：自动识别用户最常使用的记录类型
- **评分趋势**：分析用户评分习惯的变化趋势
- **活跃度峰值**：找出用户最活跃的日期
- **完成率**：展示用户完成计划的进度

## 7. 性能优化

### 7.1 后端优化

1. **批量查询**：使用 `selectBatchIds` 批量查询关联数据
2. **数据转换**：使用 `BeanUtils.toBean()` 进行对象属性复制
3. **索引优化**：在日期字段上建立索引，提高查询效率

### 7.2 前端优化

1. **按需加载**：数据洞察接口失败时静默处理，不影响主流程
2. **条件渲染**：只在有数据时渲染组件
3. **响应式设计**：适配不同屏幕尺寸

## 8. 错误处理

### 8.1 后端错误处理

- 用户未授权：返回 `UNAUTHORIZED` 异常
- 参数验证：使用 `@Valid` 注解进行参数校验
- 空数据处理：返回空对象而非null，避免前端报错

### 8.2 前端错误处理

- API调用失败：显示错误提示（统计概览）或静默失败（数据洞察）
- 图片加载失败：显示默认图标
- 数据为空：显示友好的空状态提示

## 9. 未来扩展

### 9.1 已规划功能

- [ ] 主要图表（折线图、饼图、柱状图）
- [ ] 日历热力图展示活动分布
- [ ] 详细统计页面（点击卡片跳转）
- [ ] 对比功能（与上月/去年同期对比）
- [ ] 预测分析功能
- [ ] 关联分析功能
- [ ] 导出统计报告功能

### 9.2 优化方向

- 缓存机制：对统计数据进行缓存，减少数据库查询
- 异步计算：大数据量时使用异步任务计算统计
- 数据聚合：定期预计算统计数据，提高响应速度

## 10. 总结

数据统计功能是兴趣追踪系统的核心模块，提供了：

1. **全面的统计信息**：覆盖7种记录类型，支持多维度统计
2. **智能的数据洞察**：自动分析用户行为模式
3. **灵活的时间范围**：支持多种时间范围查询
4. **直观的可视化**：趋势图表和洞察卡片
5. **准确的统计数据**：基于实际活动日期，而非记录创建时间

该功能为用户提供了深入了解自己兴趣记录习惯的能力，帮助用户更好地管理和追踪自己的兴趣爱好。

