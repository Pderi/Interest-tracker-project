# æ•°æ®æ¥æºæ–¹æ¡ˆè®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å½±è§†å’ŒéŸ³ä¹æ•°æ®çš„è·å–æ–¹æ¡ˆï¼Œè§£å†³ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ æ•°æ®çš„é—®é¢˜ã€‚

---

## ä¸€ã€é—®é¢˜åˆ†æ

### 1.1 æ ¸å¿ƒé—®é¢˜

ç”¨æˆ·éœ€è¦æ·»åŠ å½±è§†å’ŒéŸ³ä¹æ•°æ®æ—¶ï¼Œå¦‚æœæ‰‹åŠ¨è¾“å…¥æ‰€æœ‰ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å¯¼æ¼”ã€æ¼”å‘˜ã€è¯„åˆ†ã€æµ·æŠ¥ç­‰ï¼‰ï¼Œä½“éªŒä¼šéå¸¸å·®ã€‚

### 1.2 è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨ **"æœç´¢ + è‡ªåŠ¨å¡«å……"** çš„æ¨¡å¼ï¼š
1. ç”¨æˆ·è¾“å…¥å…³é”®è¯ï¼ˆå¦‚ç”µå½±åã€æ­Œæ›²åï¼‰
2. ç³»ç»Ÿè°ƒç”¨ç¬¬ä¸‰æ–¹ API æœç´¢
3. ç”¨æˆ·é€‰æ‹©åŒ¹é…çš„ç»“æœ
4. ç³»ç»Ÿè‡ªåŠ¨å¡«å……è¯¦ç»†ä¿¡æ¯

---

## äºŒã€å½±è§†æ•°æ®æ¥æºæ–¹æ¡ˆ

### 2.1 æ¨èæ–¹æ¡ˆï¼šTMDB API â­â­â­â­â­

**The Movie Database (TMDB)** æ˜¯æœ€æ¨èçš„å½±è§†æ•°æ®æ¥æºã€‚

#### 2.1.1 ä¼˜åŠ¿

- âœ… **å®Œå…¨å…è´¹**ï¼šä¸ªäººé¡¹ç›®å…è´¹ä½¿ç”¨
- âœ… **æ•°æ®ä¸°å¯Œ**ï¼šåŒ…å«ç”µå½±ã€ç”µè§†å‰§ã€æ¼”å‘˜ã€å¯¼æ¼”ç­‰å®Œæ•´ä¿¡æ¯
- âœ… **ä¸­æ–‡æ”¯æŒ**ï¼šæ”¯æŒä¸­æ–‡æœç´¢å’Œä¸­æ–‡æ•°æ®
- âœ… **API ç¨³å®š**ï¼šå®˜æ–¹ç»´æŠ¤ï¼ŒAPI ç¨³å®šå¯é 
- âœ… **æµ·æŠ¥å›¾ç‰‡**ï¼šæä¾›é«˜æ¸…æµ·æŠ¥å’Œå‰§ç…§
- âœ… **è¯„åˆ†ç³»ç»Ÿ**ï¼šåŒ…å« TMDB è¯„åˆ†å’Œç”¨æˆ·è¯„åˆ†
- âœ… **æ–‡æ¡£å®Œå–„**ï¼šAPI æ–‡æ¡£è¯¦ç»†ï¼Œæ˜“äºé›†æˆ

#### 2.1.2 API ä¿¡æ¯

- **å®˜ç½‘**ï¼šhttps://www.themoviedb.org/
- **API æ–‡æ¡£**ï¼šhttps://developers.themoviedb.org/3
- **æ³¨å†Œåœ°å€**ï¼šhttps://www.themoviedb.org/settings/api
- **å…è´¹é¢åº¦**ï¼šæ¯åˆ†é’Ÿ 40 æ¬¡è¯·æ±‚ï¼ˆè¶³å¤Ÿä½¿ç”¨ï¼‰

#### 2.1.3 æ ¸å¿ƒæ¥å£

```java
// æœç´¢ç”µå½±/ç”µè§†å‰§
GET https://api.themoviedb.org/3/search/multi?api_key={api_key}&query={å…³é”®è¯}&language=zh-CN

// è·å–ç”µå½±è¯¦æƒ…
GET https://api.themoviedb.org/3/movie/{movie_id}?api_key={api_key}&language=zh-CN

// è·å–ç”µè§†å‰§è¯¦æƒ…
GET https://api.themoviedb.org/3/tv/{tv_id}?api_key={api_key}&language=zh-CN

// è·å–å›¾ç‰‡ï¼ˆæµ·æŠ¥ã€å‰§ç…§ï¼‰
GET https://image.tmdb.org/t/p/w500/{image_path}
```

#### 2.1.4 è¿”å›æ•°æ®ç¤ºä¾‹

```json
{
  "id": 550,
  "title": "æå‡»ä¿±ä¹éƒ¨",
  "original_title": "Fight Club",
  "overview": "ä¸€ä¸ªå¤±çœ ç—‡æ‚£è€…...",
  "release_date": "1999-10-15",
  "vote_average": 8.4,
  "vote_count": 25000,
  "poster_path": "/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg",
  "backdrop_path": "/87hTDiay2N2qWyX4am7hEH7lRnj.jpg",
  "genres": [
    {"id": 18, "name": "å‰§æƒ…"},
    {"id": 53, "name": "æƒŠæ‚š"}
  ],
  "runtime": 139,
  "director": "å¤§å«Â·èŠ¬å¥‡",
  "cast": [...]
}
```

#### 2.1.5 å®ç°æ­¥éª¤

1. **æ³¨å†Œ TMDB è´¦å·**ï¼šè·å– API Key
2. **åˆ›å»º TMDB å®¢æˆ·ç«¯**ï¼šå°è£… HTTP è¯·æ±‚
3. **å®ç°æœç´¢æ¥å£**ï¼šæ ¹æ®å…³é”®è¯æœç´¢å½±è§†
4. **å®ç°è¯¦æƒ…æ¥å£**ï¼šæ ¹æ® ID è·å–è¯¦ç»†ä¿¡æ¯
5. **æ•°æ®æ˜ å°„**ï¼šå°† TMDB æ•°æ®æ˜ å°„åˆ°æœ¬åœ° MovieDO

### 2.2 å¤‡é€‰æ–¹æ¡ˆä¸€ï¼šè±†ç“£ API

#### 2.2.1 ä¼˜åŠ¿

- âœ… ä¸­æ–‡æ•°æ®ä¸°å¯Œ
- âœ… è¯„åˆ†ç³»ç»Ÿå®Œå–„
- âœ… ç”¨æˆ·è¯„ä»·å¤š

#### 2.2.2 åŠ£åŠ¿

- âŒ **å®˜æ–¹ API å·²åœæ­¢ç”³è¯·**ï¼šåªèƒ½ä½¿ç”¨éå®˜æ–¹ API
- âŒ éå®˜æ–¹ API ä¸ç¨³å®šï¼Œå¯èƒ½éšæ—¶å¤±æ•ˆ
- âŒ æœ‰æ³•å¾‹é£é™©

#### 2.2.3 å»ºè®®

**ä¸æ¨èä½¿ç”¨**ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ã€‚

### 2.3 å¤‡é€‰æ–¹æ¡ˆäºŒï¼šOMDb API

#### 2.3.1 ä¼˜åŠ¿

- âœ… å…è´¹ç‰ˆæœ¬å¯ç”¨
- âœ… æ•°æ®æ¥æº IMDb
- âœ… API ç®€å•æ˜“ç”¨

#### 2.3.2 åŠ£åŠ¿

- âŒ å…è´¹ç‰ˆæ¯å¤© 1000 æ¬¡è¯·æ±‚é™åˆ¶
- âŒ ä¸­æ–‡æ”¯æŒè¾ƒå·®
- âŒ æ•°æ®ä¸å¦‚ TMDB ä¸°å¯Œ

#### 2.3.3 å»ºè®®

ä½œä¸º TMDB çš„å¤‡é€‰æ–¹æ¡ˆã€‚

---

## ä¸‰ã€éŸ³ä¹æ•°æ®æ¥æºæ–¹æ¡ˆ

### 3.1 æ¨èæ–¹æ¡ˆï¼šLast.fm API â­â­â­â­

**Last.fm** æ˜¯æ¨èçš„éŸ³ä¹æ•°æ®æ¥æºã€‚

#### 3.1.1 ä¼˜åŠ¿

- âœ… **å®Œå…¨å…è´¹**ï¼šæ— éœ€ä»˜è´¹
- âœ… **æ•°æ®ä¸°å¯Œ**ï¼šåŒ…å«æ­Œæ›²ã€ä¸“è¾‘ã€è‰ºæœ¯å®¶ä¿¡æ¯
- âœ… **API ç¨³å®š**ï¼šå®˜æ–¹ç»´æŠ¤
- âœ… **å…¨çƒæ•°æ®**ï¼šè¦†ç›–å…¨çƒéŸ³ä¹åº“
- âœ… **æ ‡ç­¾ç³»ç»Ÿ**ï¼šæ”¯æŒéŸ³ä¹ç±»å‹æ ‡ç­¾

#### 3.1.2 API ä¿¡æ¯

- **å®˜ç½‘**ï¼šhttps://www.last.fm/
- **API æ–‡æ¡£**ï¼šhttps://www.last.fm/api
- **æ³¨å†Œåœ°å€**ï¼šhttps://www.last.fm/api/account/create
- **å…è´¹é¢åº¦**ï¼šæ— é™åˆ¶ï¼ˆä½†å»ºè®®æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼‰

#### 3.1.3 æ ¸å¿ƒæ¥å£

```java
// æœç´¢æ­Œæ›²
GET http://ws.audioscrobbler.com/2.0/?method=track.search&track={æ­Œæ›²å}&api_key={api_key}&format=json

// è·å–æ­Œæ›²ä¿¡æ¯
GET http://ws.audioscrobbler.com/2.0/?method=track.getInfo&track={æ­Œæ›²å}&artist={è‰ºæœ¯å®¶}&api_key={api_key}&format=json

// æœç´¢è‰ºæœ¯å®¶
GET http://ws.audioscrobbler.com/2.0/?method=artist.search&artist={è‰ºæœ¯å®¶å}&api_key={api_key}&format=json
```

#### 3.1.4 è¿”å›æ•°æ®ç¤ºä¾‹

```json
{
  "track": {
    "name": "Bohemian Rhapsody",
    "artist": {
      "name": "Queen"
    },
    "album": {
      "title": "A Night at the Opera",
      "image": [
        {"#text": "https://...", "size": "large"}
      ]
    },
    "duration": "355000",
    "listeners": "5000000",
    "playcount": "100000000",
    "tags": {
      "tag": [
        {"name": "rock"},
        {"name": "classic rock"}
      ]
    }
  }
}
```

### 3.2 å¤‡é€‰æ–¹æ¡ˆä¸€ï¼šSpotify API

#### 3.2.1 ä¼˜åŠ¿

- âœ… æ•°æ®éå¸¸ä¸°å¯Œ
- âœ… éŸ³é¢‘é¢„è§ˆåŠŸèƒ½
- âœ… å®˜æ–¹ APIï¼Œç¨³å®šå¯é 

#### 3.2.2 åŠ£åŠ¿

- âŒ éœ€è¦ OAuth è®¤è¯ï¼ˆè¾ƒå¤æ‚ï¼‰
- âŒ å…è´¹ç‰ˆæœ‰è¯·æ±‚é™åˆ¶
- âŒ éœ€è¦ç”¨æˆ·æˆæƒ

#### 3.2.3 å»ºè®®

å¦‚æœåªéœ€è¦æœç´¢å’Œè·å–ä¿¡æ¯ï¼ŒLast.fm æ›´ç®€å•ã€‚å¦‚æœéœ€è¦éŸ³é¢‘æ’­æ”¾ï¼Œå¯ä»¥è€ƒè™‘ Spotifyã€‚

### 3.3 å¤‡é€‰æ–¹æ¡ˆäºŒï¼šç½‘æ˜“äº‘éŸ³ä¹ APIï¼ˆéå®˜æ–¹ï¼‰

#### 3.3.1 ä¼˜åŠ¿

- âœ… ä¸­æ–‡æ•°æ®ä¸°å¯Œ
- âœ… å›½å†…ç”¨æˆ·ç†Ÿæ‚‰

#### 3.3.2 åŠ£åŠ¿

- âŒ **éå®˜æ–¹ API**ï¼šå¯èƒ½éšæ—¶å¤±æ•ˆ
- âŒ æœ‰æ³•å¾‹é£é™©
- âŒ ä¸ç¨³å®š

#### 3.3.3 å»ºè®®

**ä¸æ¨èä½¿ç”¨**ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ã€‚

### 3.4 å¤‡é€‰æ–¹æ¡ˆä¸‰ï¼šMusicBrainz API

#### 3.4.1 ä¼˜åŠ¿

- âœ… å¼€æºæ•°æ®åº“
- âœ… æ•°æ®å‡†ç¡®
- âœ… å…è´¹ä½¿ç”¨

#### 3.4.2 åŠ£åŠ¿

- âŒ API è¾ƒå¤æ‚
- âŒ ä¸­æ–‡æ”¯æŒä¸€èˆ¬

---

## å››ã€å®ç°æ–¹æ¡ˆè®¾è®¡

### 4.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·ç•Œé¢å±‚                        â”‚
â”‚  - æœç´¢è¾“å…¥æ¡†                            â”‚
â”‚  - æœç´¢ç»“æœåˆ—è¡¨                          â”‚
â”‚  - é€‰æ‹©ç¡®è®¤                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Controller å±‚                    â”‚
â”‚  - MovieController.search()              â”‚
â”‚  - SongController.search()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Service å±‚                       â”‚
â”‚  - MovieService.searchFromTMDB()         â”‚
â”‚  - SongService.searchFromLastFM()        â”‚
â”‚  - MovieService.createFromTMDB()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç¬¬ä¸‰æ–¹ API å®¢æˆ·ç«¯å±‚                   â”‚
â”‚  - TMDBClient                            â”‚
â”‚  - LastFMClient                          â”‚
â”‚  - ç¼“å­˜å±‚ï¼ˆRedisï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç¬¬ä¸‰æ–¹ API                        â”‚
â”‚  - TMDB API                              â”‚
â”‚  - Last.fm API                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

#### 4.2.1 æœç´¢åŠŸèƒ½

**æµç¨‹**ï¼š
1. ç”¨æˆ·è¾“å…¥å…³é”®è¯
2. è°ƒç”¨ç¬¬ä¸‰æ–¹ API æœç´¢
3. è¿”å›æœç´¢ç»“æœåˆ—è¡¨
4. ç”¨æˆ·é€‰æ‹©åŒ¹é…é¡¹
5. è‡ªåŠ¨å¡«å……è¯¦ç»†ä¿¡æ¯

**æ¥å£è®¾è®¡**ï¼š
```java
// æœç´¢å½±è§†
GET /api/movie/search?keyword={å…³é”®è¯}
Response: List<MovieSearchResultVO>

// æ ¹æ® TMDB ID åˆ›å»ºå½±è§†
POST /api/movie/create-from-tmdb
Body: {tmdbId: 550, type: "movie"}

// æœç´¢æ­Œæ›²
GET /api/song/search?keyword={å…³é”®è¯}
Response: List<SongSearchResultVO>

// æ ¹æ® Last.fm ä¿¡æ¯åˆ›å»ºæ­Œæ›²
POST /api/song/create-from-lastfm
Body: {trackName: "xxx", artistName: "xxx"}
```

#### 4.2.2 æ•°æ®ç¼“å­˜ç­–ç•¥

**ç¼“å­˜ç›®çš„**ï¼š
- å‡å°‘ç¬¬ä¸‰æ–¹ API è°ƒç”¨
- æé«˜å“åº”é€Ÿåº¦
- èŠ‚çœ API é¢åº¦

**ç¼“å­˜ç­–ç•¥**ï¼š
- **æœç´¢ç»“æœ**ï¼šç¼“å­˜ 1 å°æ—¶ï¼ˆRedisï¼‰
- **è¯¦ç»†ä¿¡æ¯**ï¼šç¼“å­˜ 24 å°æ—¶ï¼ˆRedisï¼‰
- **æµ·æŠ¥å›¾ç‰‡**ï¼šä¸‹è½½åˆ°æœ¬åœ°æˆ– OSSï¼Œæ°¸ä¹…ç¼“å­˜

#### 4.2.3 æ•°æ®æ˜ å°„

**TMDB â†’ MovieDO æ˜ å°„**ï¼š
```java
MovieDO movieDO = new MovieDO();
movieDO.setTitle(tmdbData.getTitle());
movieDO.setOriginalTitle(tmdbData.getOriginalTitle());
movieDO.setDescription(tmdbData.getOverview());
movieDO.setReleaseYear(extractYear(tmdbData.getReleaseDate()));
movieDO.setDirector(extractDirector(tmdbData.getCredits()));
movieDO.setActors(extractActors(tmdbData.getCredits()));
movieDO.setGenre(extractGenres(tmdbData.getGenres()));
movieDO.setRating(tmdbData.getVoteAverage());
movieDO.setPosterUrl(buildImageUrl(tmdbData.getPosterPath()));
movieDO.setDuration(tmdbData.getRuntime());
```

**Last.fm â†’ SongDO æ˜ å°„**ï¼š
```java
SongDO songDO = new SongDO();
songDO.setTitle(lastfmData.getTrack().getName());
songDO.setArtist(lastfmData.getTrack().getArtist().getName());
songDO.setAlbum(lastfmData.getTrack().getAlbum().getTitle());
songDO.setDuration(parseDuration(lastfmData.getTrack().getDuration()));
songDO.setGenre(extractGenres(lastfmData.getTrack().getTags()));
songDO.setSourceUrl(lastfmData.getTrack().getUrl());
```

### 4.3 ä»£ç å®ç°ç¤ºä¾‹

#### 4.3.1 TMDB å®¢æˆ·ç«¯

```java
@Service
public class TMDBClient {
    
    @Value("${tmdb.api.key}")
    private String apiKey;
    
    @Value("${tmdb.api.base-url:https://api.themoviedb.org/3}")
    private String baseUrl;
    
    @Resource
    private RestTemplate restTemplate;
    
    /**
     * æœç´¢å½±è§†
     */
    public TMDBSearchResponse search(String keyword, String language) {
        String url = baseUrl + "/search/multi" +
            "?api_key=" + apiKey +
            "&query=" + URLEncoder.encode(keyword, StandardCharsets.UTF_8) +
            "&language=" + language;
        
        return restTemplate.getForObject(url, TMDBSearchResponse.class);
    }
    
    /**
     * è·å–ç”µå½±è¯¦æƒ…
     */
    public TMDBMovieDetail getMovieDetail(Long movieId, String language) {
        String url = baseUrl + "/movie/" + movieId +
            "?api_key=" + apiKey +
            "&language=" + language +
            "&append_to_response=credits";
        
        return restTemplate.getForObject(url, TMDBMovieDetail.class);
    }
    
    /**
     * è·å–ç”µè§†å‰§è¯¦æƒ…
     */
    public TMDBTVDetail getTVDetail(Long tvId, String language) {
        String url = baseUrl + "/tv/" + tvId +
            "?api_key=" + apiKey +
            "&language=" + language +
            "&append_to_response=credits";
        
        return restTemplate.getForObject(url, TMDBTVDetail.class);
    }
}
```

#### 4.3.2 MovieService é›†æˆ

```java
@Service
public class MovieServiceImpl implements MovieService {
    
    @Resource
    private TMDBClient tmdbClient;
    
    @Resource
    private MovieMapper movieMapper;
    
    /**
     * æœç´¢å½±è§†ï¼ˆä» TMDBï¼‰
     */
    public List<MovieSearchResultVO> searchFromTMDB(String keyword) {
        // 1. æ£€æŸ¥ç¼“å­˜
        String cacheKey = "movie:search:" + keyword;
        List<MovieSearchResultVO> cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // 2. è°ƒç”¨ TMDB API
        TMDBSearchResponse response = tmdbClient.search(keyword, "zh-CN");
        
        // 3. è½¬æ¢ä¸º VO
        List<MovieSearchResultVO> results = response.getResults().stream()
            .map(this::convertToSearchVO)
            .collect(Collectors.toList());
        
        // 4. ç¼“å­˜ç»“æœï¼ˆ1å°æ—¶ï¼‰
        redisTemplate.opsForValue().set(cacheKey, results, 1, TimeUnit.HOURS);
        
        return results;
    }
    
    /**
     * ä» TMDB åˆ›å»ºå½±è§†
     */
    @Transactional(rollbackFor = Exception.class)
    public Long createFromTMDB(Long tmdbId, Integer type) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        MovieDO existing = movieMapper.selectOne(
            new LambdaQueryWrapper<MovieDO>()
                .eq(MovieDO::getTmdbId, tmdbId)
        );
        if (existing != null) {
            return existing.getId();
        }
        
        // 2. è·å–è¯¦ç»†ä¿¡æ¯
        TMDBMovieDetail detail = type == 1 
            ? tmdbClient.getMovieDetail(tmdbId, "zh-CN")
            : tmdbClient.getTVDetail(tmdbId, "zh-CN");
        
        // 3. è½¬æ¢ä¸º DO
        MovieDO movieDO = convertTMDBToDO(detail, type);
        movieDO.setTmdbId(tmdbId);
        
        // 4. ä¿å­˜
        movieMapper.insert(movieDO);
        
        return movieDO.getId();
    }
}
```

---

## äº”ã€æ•°æ®åº“æ‰©å±•

### 5.1 æ·»åŠ ç¬¬ä¸‰æ–¹ ID å­—æ®µ

éœ€è¦åœ¨ `movie` å’Œ `song` è¡¨ä¸­æ·»åŠ ç¬¬ä¸‰æ–¹ ID å­—æ®µï¼š

```sql
-- å½±è§†è¡¨æ·»åŠ  TMDB ID
ALTER TABLE `movie` 
ADD COLUMN `tmdb_id` BIGINT DEFAULT NULL COMMENT 'TMDB ID' AFTER `id`,
ADD UNIQUE KEY `uk_tmdb_id` (`tmdb_id`);

-- æ­Œæ›²è¡¨æ·»åŠ  Last.fm IDï¼ˆå¯é€‰ï¼‰
ALTER TABLE `song` 
ADD COLUMN `lastfm_id` VARCHAR(128) DEFAULT NULL COMMENT 'Last.fm ID' AFTER `id`;
```

### 5.2 æ·»åŠ ç¼“å­˜è¡¨ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æŒä¹…åŒ–ç¼“å­˜æœç´¢ç»“æœï¼š

```sql
CREATE TABLE `api_cache` (
    `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
    `cache_key` VARCHAR(255) NOT NULL COMMENT 'ç¼“å­˜é”®',
    `cache_value` TEXT NOT NULL COMMENT 'ç¼“å­˜å€¼ï¼ˆJSONï¼‰',
    `expire_time` DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_cache_key` (`cache_key`),
    KEY `idx_expire_time` (`expire_time`)
) COMMENT='APIç¼“å­˜è¡¨';
```

---

## å…­ã€é…ç½®è¯´æ˜

### 6.1 application.yml é…ç½®

```yaml
# ç¬¬ä¸‰æ–¹ API é…ç½®
tmdb:
  api:
    key: ${TMDB_API_KEY:your_api_key_here}
    base-url: https://api.themoviedb.org/3
    image-base-url: https://image.tmdb.org/t/p
    language: zh-CN
    timeout: 5000

lastfm:
  api:
    key: ${LASTFM_API_KEY:your_api_key_here}
    base-url: http://ws.audioscrobbler.com/2.0
    timeout: 5000

# ç¼“å­˜é…ç½®
cache:
  movie-search-ttl: 3600  # å½±è§†æœç´¢ç»“æœç¼“å­˜1å°æ—¶
  movie-detail-ttl: 86400  # å½±è§†è¯¦æƒ…ç¼“å­˜24å°æ—¶
  song-search-ttl: 3600    # æ­Œæ›²æœç´¢ç»“æœç¼“å­˜1å°æ—¶
```

### 6.2 ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æˆ–ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š

```bash
TMDB_API_KEY=your_tmdb_api_key
LASTFM_API_KEY=your_lastfm_api_key
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### 7.1 ç¬¬ä¸€é˜¶æ®µï¼šTMDB é›†æˆï¼ˆå½±è§†ï¼‰

1. **æ³¨å†Œ TMDB è´¦å·**ï¼šhttps://www.themoviedb.org/settings/api
2. **è·å– API Key**
3. **åˆ›å»º TMDBClient**ï¼šå°è£… HTTP è¯·æ±‚
4. **å®ç°æœç´¢æ¥å£**ï¼š`/api/movie/search`
5. **å®ç°åˆ›å»ºæ¥å£**ï¼š`/api/movie/create-from-tmdb`
6. **æ·»åŠ ç¼“å­˜**ï¼šRedis ç¼“å­˜æœç´¢ç»“æœ
7. **æµ‹è¯•éªŒè¯**ï¼šæµ‹è¯•æœç´¢å’Œåˆ›å»ºåŠŸèƒ½

### 7.2 ç¬¬äºŒé˜¶æ®µï¼šLast.fm é›†æˆï¼ˆéŸ³ä¹ï¼‰

1. **æ³¨å†Œ Last.fm è´¦å·**ï¼šhttps://www.last.fm/api/account/create
2. **è·å– API Key**
3. **åˆ›å»º LastFMClient**ï¼šå°è£… HTTP è¯·æ±‚
4. **å®ç°æœç´¢æ¥å£**ï¼š`/api/song/search`
5. **å®ç°åˆ›å»ºæ¥å£**ï¼š`/api/song/create-from-lastfm`
6. **æ·»åŠ ç¼“å­˜**ï¼šRedis ç¼“å­˜æœç´¢ç»“æœ
7. **æµ‹è¯•éªŒè¯**ï¼šæµ‹è¯•æœç´¢å’Œåˆ›å»ºåŠŸèƒ½

### 7.3 ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–

1. **é”™è¯¯å¤„ç†**ï¼šAPI è°ƒç”¨å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆ
2. **é™æµæ§åˆ¶**ï¼šé¿å…è¶…è¿‡ API é™åˆ¶
3. **å›¾ç‰‡å¤„ç†**ï¼šä¸‹è½½æµ·æŠ¥åˆ°æœ¬åœ°æˆ– OSS
4. **æ•°æ®åŒæ­¥**ï¼šå®šæœŸæ›´æ–°å·²æ·»åŠ çš„å½±è§†/éŸ³ä¹ä¿¡æ¯

---

## å…«ã€é™çº§æ–¹æ¡ˆ

### 8.1 API è°ƒç”¨å¤±è´¥

å¦‚æœç¬¬ä¸‰æ–¹ API è°ƒç”¨å¤±è´¥ï¼Œæä¾›é™çº§æ–¹æ¡ˆï¼š

1. **æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥**ï¼šæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥è¡¨å•
2. **ä½¿ç”¨æœ¬åœ°ç¼“å­˜**ï¼šå¦‚æœä¹‹å‰æœç´¢è¿‡ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®
3. **ç®€åŒ–ä¿¡æ¯**ï¼šåªè¦æ±‚è¾“å…¥å¿…è¦å­—æ®µï¼ˆæ ‡é¢˜ã€ç±»å‹ï¼‰

### 8.2 é™æµå¤„ç†

å¦‚æœè¶…è¿‡ API è°ƒç”¨é™åˆ¶ï¼š

1. **æç¤ºç”¨æˆ·ç¨åé‡è¯•**
2. **ä½¿ç”¨ç¼“å­˜æ•°æ®**
3. **å¼•å¯¼ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥**

---

## ä¹ã€æ€»ç»“

### 9.1 æ¨èæ–¹æ¡ˆ

- **å½±è§†æ•°æ®**ï¼šTMDB APIï¼ˆé¦–é€‰ï¼‰
- **éŸ³ä¹æ•°æ®**ï¼šLast.fm APIï¼ˆé¦–é€‰ï¼‰

### 9.2 æ ¸å¿ƒä¼˜åŠ¿

- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼šæœç´¢å³å¯è‡ªåŠ¨å¡«å……
- âœ… æ•°æ®å‡†ç¡®ï¼šæ¥è‡ªæƒå¨æ•°æ®æº
- âœ… å®ç°ç®€å•ï¼šAPI æ–‡æ¡£å®Œå–„
- âœ… æˆæœ¬ä½ï¼šå…è´¹ä½¿ç”¨

### 9.3 æ³¨æ„äº‹é¡¹

- âš ï¸ éœ€è¦æ³¨å†Œ API Key
- âš ï¸ æ³¨æ„ API è°ƒç”¨é¢‘ç‡é™åˆ¶
- âš ï¸ åšå¥½é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
- âš ï¸ åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘ API è°ƒç”¨

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-12-07

