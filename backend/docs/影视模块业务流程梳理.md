# 影视模块业务流程梳理

## 📋 文档说明

本文档详细梳理影视模块的核心业务流程，包括数据模型、业务规则、接口设计和实现要点。本文档作为开发前的设计参考，不涉及具体代码实现。

**版本**: v1.0  
**创建日期**: 2025-12-19  
**状态**: 设计阶段

---

## 一、业务概述

### 1.1 核心功能

影视模块是兴趣追踪系统的核心模块之一，主要功能包括：

1. **影视信息管理**：通过TMDB API搜索影视，或手动创建影视信息
2. **观看记录管理**：记录用户的观看状态、评分、进度、评价等
3. **标签管理**：支持AI自动生成标签和手动编辑标签
4. **数据查询**：支持多维度查询和统计

### 1.2 业务价值

- **提升记录效率**：通过TMDB API自动填充影视信息，减少手动输入
- **个性化管理**：支持个人评分、标签、评价等个性化信息
- **数据沉淀**：积累用户的观影数据，为后续推荐和分析提供基础

---

## 二、数据模型设计

### 2.1 核心实体

#### 2.1.1 影视实体（Movie）

**表名**: `movie`

**字段说明**：

| 字段 | 类型 | 说明 | 来源 |
|------|------|------|------|
| id | BIGINT | 主键ID | 自增 |
| title | VARCHAR(255) | 标题 | TMDB/手动 |
| type | TINYINT | 类型：1-电影 2-电视剧 | 必填 |
| genre | VARCHAR(128) | 类型（动作、科幻等，逗号分隔） | TMDB/手动 |
| release_year | INT | 上映年份 | TMDB/手动 |
| director | VARCHAR(128) | 导演 | TMDB/手动 |
| actors | VARCHAR(512) | 演员（逗号分隔） | TMDB/手动 |
| description | TEXT | 简介 | TMDB/手动 |
| poster_url | VARCHAR(512) | 海报URL | TMDB/手动 |
| rating | DECIMAL(3,1) | 评分（0-10） | TMDB |
| duration | INT | 时长（分钟） | TMDB/手动 |
| tmdb_id | BIGINT | TMDB ID（可选） | TMDB |
| creator | VARCHAR(64) | 创建者 | 系统 |
| create_time | DATETIME | 创建时间 | 系统 |
| updater | VARCHAR(64) | 更新者 | 系统 |
| update_time | DATETIME | 更新时间 | 系统 |
| deleted | TINYINT | 是否删除：0-否 1-是 | 系统 |

**业务规则**：
- `title` 和 `type` 为必填字段
- `tmdb_id` 用于关联TMDB数据，可空（支持手动创建）
- 同一 `tmdb_id` 在同一用户下应该唯一（避免重复添加）

#### 2.1.2 观看记录实体（MovieRecord）

**表名**: `movie_record`

**字段说明**：

| 字段 | 类型 | 说明 | 来源 |
|------|------|------|------|
| id | BIGINT | 主键ID | 自增 |
| user_id | BIGINT | 用户ID | 系统 |
| movie_id | BIGINT | 影视ID | 必填 |
| watch_status | TINYINT | 观看状态：1-想看 2-在看 3-已看 4-弃剧 | 用户 |
| personal_rating | DECIMAL(3,1) | 个人评分（0-10） | 用户 |
| watch_date | DATE | 观看日期 | 用户 |
| watch_duration | INT | 观看时长（分钟） | 用户 |
| progress | DECIMAL(5,2) | 观看进度（0-100） | 用户 |
| comment | TEXT | 评价 | 用户 |
| tags | VARCHAR(512) | 标签（逗号分隔） | AI/用户 |
| creator | VARCHAR(64) | 创建者 | 系统 |
| create_time | DATETIME | 创建时间 | 系统 |
| updater | VARCHAR(64) | 更新者 | 系统 |
| update_time | DATETIME | 更新时间 | 系统 |
| deleted | TINYINT | 是否删除：0-否 1-是 | 系统 |

**业务规则**：
- `user_id` 和 `movie_id` 组合唯一（一个用户对一个影视只能有一条记录）
- `watch_status` 默认为 1（想看）
- `personal_rating` 支持 0.5 步长（如 8.5）
- `progress` 用于记录观看进度，适用于电视剧

### 2.2 数据关系

```
用户 (User)
  └── 1:N ──> 观看记录 (MovieRecord)
                └── N:1 ──> 影视 (Movie)
```

**关系说明**：
- 一个用户可以有多个观看记录
- 一个影视可以被多个用户记录
- 一个观看记录关联一个影视和一个用户

---

## 三、核心业务流程

### 3.1 添加影视记录流程

#### 3.1.1 通过TMDB搜索添加

**流程步骤**：

```
1. 用户输入关键词（如"搏击俱乐部"）
   ↓
2. 前端调用搜索接口 GET /api/movies/search?keyword=搏击俱乐部
   ↓
3. 后端调用TMDB API搜索
   ↓
4. 返回搜索结果列表（包含tmdbId、title、year、posterUrl等）
   ↓
5. 用户选择匹配的影视
   ↓
6. 前端调用创建接口 POST /api/movies
   Body: { tmdbId: 550, type: 1 }
   ↓
7. 后端根据tmdbId获取详细信息
   ↓
8. 创建Movie记录（如果不存在）
   ↓
9. 创建MovieRecord记录（关联当前用户）
   ↓
10. 返回记录ID
```

**关键点**：
- 搜索接口需要缓存结果（减少TMDB API调用）
- 创建时需要检查是否已存在（避免重复）
- 创建Movie和MovieRecord是原子操作（事务）

#### 3.1.2 手动创建

**流程步骤**：

```
1. 用户点击"手动添加"
   ↓
2. 前端显示手动输入表单
   ↓
3. 用户填写基本信息（title、type必填，其他可选）
   ↓
4. 前端调用创建接口 POST /api/movies
   Body: { title: "xxx", type: 1, ... }
   ↓
5. 后端创建Movie记录
   ↓
6. 创建MovieRecord记录（关联当前用户）
   ↓
7. 返回记录ID
```

**关键点**：
- 手动创建时 `tmdb_id` 为空
- 必填字段校验：`title`、`type`
- 可选字段可以后续补充

### 3.2 更新观看记录流程

**流程步骤**：

```
1. 用户查看自己的观看记录
   ↓
2. 用户编辑记录（状态、评分、进度、评价、标签等）
   ↓
3. 前端调用更新接口 PUT /api/movies/records/{id}
   Body: { watchStatus: 3, personalRating: 8.5, ... }
   ↓
4. 后端校验记录归属（只能更新自己的记录）
   ↓
5. 更新MovieRecord记录
   ↓
6. 返回成功
```

**业务规则**：
- 只能更新自己的记录（越权校验）
- 状态变更时，可以自动更新 `watch_date`（如：状态改为"已看"时，自动设置为当前日期）
- 评分支持 0.5 步长

### 3.3 生成AI标签流程

**流程步骤**：

```
1. 用户点击"生成标签"按钮
   ↓
2. 前端调用接口 POST /api/movies/{id}/ai-tags
   ↓
3. 后端获取影视信息（title、description、genre等）
   ↓
4. 调用AI服务（Hugging Face / Gemini）
   输入：影视信息
   输出：3-5个标签
   ↓
5. 更新MovieRecord的tags字段
   ↓
6. 返回生成的标签列表
```

**降级方案**：
- AI调用失败时，返回错误码，提示用户手动添加
- 支持重试机制
- 可以缓存AI生成结果（相同影视信息生成相同标签）

### 3.4 查询列表流程

**流程步骤**：

```
1. 用户进入影视列表页面
   ↓
2. 前端调用列表接口 GET /api/movies?pageNo=1&pageSize=10&status=3&type=1
   ↓
3. 后端查询MovieRecord（关联Movie）
   条件：
   - user_id = 当前用户
   - watch_status = 3（已看）
   - movie.type = 1（电影）
   ↓
4. 分页返回结果
   ↓
5. 前端展示列表
```

**查询维度**：
- 按观看状态筛选（想看/在看/已看/弃剧）
- 按类型筛选（电影/电视剧）
- 按标签筛选
- 按时间排序（创建时间/观看日期）
- 按评分排序

### 3.5 查看详情流程

**流程步骤**：

```
1. 用户点击列表中的影视
   ↓
2. 前端调用详情接口 GET /api/movies/{id}
   ↓
3. 后端查询Movie和MovieRecord
   ↓
4. 组装返回数据（包含影视信息和用户记录）
   ↓
5. 前端展示详情页
```

**返回数据包含**：
- 影视基本信息（Movie）
- 用户观看记录（MovieRecord）
- 关联信息（如：同类型推荐，可选）

---

## 四、接口设计

### 4.1 影视搜索接口

**接口**: `GET /api/movies/search`

**功能**: 通过TMDB搜索影视

**请求参数**:
- `keyword` (String, 必填): 搜索关键词
- `page` (Integer, 可选): 页码，默认1

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": [
    {
      "tmdbId": 550,
      "title": "搏击俱乐部",
      "originalTitle": "Fight Club",
      "type": 1,
      "releaseYear": 1999,
      "posterUrl": "https://image.tmdb.org/t/p/w500/xxx.jpg",
      "overview": "简介...",
      "rating": 8.4
    }
  ]
}
```

**业务规则**:
- 搜索结果缓存1小时
- 支持中文搜索
- 返回结果按相关性排序

### 4.2 创建影视记录接口

**接口**: `POST /api/movies`

**功能**: 创建影视记录（从TMDB或手动）

**请求体**:
```json
{
  "tmdbId": 550,           // 可选，从TMDB创建时必填
  "title": "搏击俱乐部",     // 手动创建时必填
  "type": 1,                // 必填：1-电影 2-电视剧
  "watchStatus": 1,         // 可选，默认1（想看）
  "personalRating": null,   // 可选
  "tags": null,             // 可选
  "comment": null           // 可选
}
```

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "movieId": 1,
    "recordId": 1
  }
}
```

**业务规则**:
- 如果提供 `tmdbId`，则从TMDB获取详细信息
- 如果 `tmdbId` 为空，则使用手动输入的信息
- 创建Movie和MovieRecord是原子操作
- 如果Movie已存在（相同tmdbId），则复用，只创建MovieRecord

### 4.3 更新观看记录接口

**接口**: `PUT /api/movies/records/{id}`

**功能**: 更新观看记录

**请求体**:
```json
{
  "watchStatus": 3,         // 可选
  "personalRating": 8.5,    // 可选
  "watchDate": "2025-01-15", // 可选
  "watchDuration": 139,     // 可选
  "progress": 100.0,        // 可选
  "comment": "很好看",      // 可选
  "tags": "动作,悬疑"       // 可选
}
```

**业务规则**:
- 只能更新自己的记录
- 状态改为"已看"时，如果 `watchDate` 为空，自动设置为当前日期
- 所有字段都是可选的（部分更新）

### 4.4 查询列表接口

**接口**: `GET /api/movies`

**功能**: 查询用户的影视记录列表

**请求参数**:
- `pageNo` (Integer, 必填): 页码
- `pageSize` (Integer, 必填): 每页数量
- `status` (Integer, 可选): 观看状态（1-想看 2-在看 3-已看 4-弃剧）
- `type` (Integer, 可选): 类型（1-电影 2-电视剧）
- `tag` (String, 可选): 标签筛选
- `keyword` (String, 可选): 关键词搜索（标题）
- `sort` (String, 可选): 排序字段（ctime-创建时间, watchDate-观看日期, rating-评分）

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "total": 100,
    "list": [
      {
        "recordId": 1,
        "movieId": 1,
        "title": "搏击俱乐部",
        "type": 1,
        "posterUrl": "https://...",
        "watchStatus": 3,
        "personalRating": 8.5,
        "watchDate": "2025-01-15",
        "tags": ["动作", "悬疑"],
        "createTime": "2025-01-10 10:00:00"
      }
    ]
  }
}
```

### 4.5 查看详情接口

**接口**: `GET /api/movies/{id}`

**功能**: 查看影视详情（包含用户记录）

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "movie": {
      "id": 1,
      "title": "搏击俱乐部",
      "type": 1,
      "genre": "动作,悬疑",
      "releaseYear": 1999,
      "director": "大卫·芬奇",
      "actors": "爱德华·诺顿,布拉德·皮特",
      "description": "简介...",
      "posterUrl": "https://...",
      "rating": 8.4,
      "duration": 139
    },
    "record": {
      "id": 1,
      "watchStatus": 3,
      "personalRating": 8.5,
      "watchDate": "2025-01-15",
      "watchDuration": 139,
      "progress": 100.0,
      "comment": "很好看",
      "tags": ["动作", "悬疑"]
    }
  }
}
```

### 4.6 生成AI标签接口

**接口**: `POST /api/movies/{id}/ai-tags`

**功能**: 为影视生成AI标签

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "tags": ["动作", "悬疑", "心理", "经典"]
  }
}
```

**业务规则**:
- AI调用失败时返回错误码，提示手动添加
- 生成的标签会自动更新到MovieRecord
- 支持重试

### 4.7 删除记录接口

**接口**: `DELETE /api/movies/records/{id}`

**功能**: 删除观看记录（软删除）

**业务规则**:
- 只能删除自己的记录
- 软删除（设置deleted=1）
- 删除记录不影响Movie实体

---

## 五、业务规则总结

### 5.1 数据创建规则

1. **影视创建**：
   - 通过TMDB创建：必须提供 `tmdbId`
   - 手动创建：必须提供 `title` 和 `type`
   - 同一 `tmdbId` 在同一用户下应该唯一

2. **记录创建**：
   - 创建影视时自动创建观看记录
   - 默认状态为"想看"（watchStatus=1）
   - 用户ID从当前登录用户获取

### 5.2 数据更新规则

1. **权限控制**：
   - 只能更新自己的记录
   - 管理员可以管理所有记录（后续扩展）

2. **状态变更**：
   - 状态改为"已看"时，如果 `watchDate` 为空，自动设置为当前日期
   - 状态改为"弃剧"时，可以记录原因（comment字段）

3. **评分规则**：
   - 评分范围：0-10
   - 支持 0.5 步长（如 8.5）

### 5.3 数据查询规则

1. **权限控制**：
   - 只能查询自己的记录
   - 列表查询自动过滤 `deleted=1` 的记录

2. **排序规则**：
   - 默认按创建时间倒序
   - 支持按观看日期、评分排序

3. **筛选规则**：
   - 支持多维度筛选（状态、类型、标签、关键词）
   - 筛选条件可以组合使用

### 5.4 外部服务调用规则

1. **TMDB API**：
   - 搜索结果缓存1小时
   - 详情信息缓存24小时
   - 调用失败时允许手动创建
   - 注意API调用频率限制（每分钟40次）

2. **AI服务**：
   - 优先使用免费AI（Hugging Face / Gemini）
   - 调用失败时提示手动添加
   - 支持重试机制
   - 可以缓存生成结果

---

## 六、技术实现要点

### 6.1 模块结构

```
module/movie/
├── controller/
│   └── app/
│       ├── MovieAppController.java      # 影视管理接口
│       └── vo/                         # VO对象
│           ├── MovieSearchRespVO.java
│           ├── MovieCreateReqVO.java
│           ├── MovieUpdateReqVO.java
│           ├── MoviePageReqVO.java
│           ├── MoviePageRespVO.java
│           └── MovieRespVO.java
├── service/
│   ├── MovieService.java                # 影视服务接口
│   ├── MovieRecordService.java          # 观看记录服务接口
│   └── impl/
│       ├── MovieServiceImpl.java
│       └── MovieRecordServiceImpl.java
├── dal/
│   ├── dataobject/
│   │   ├── MovieDO.java                 # 影视DO
│   │   └── MovieRecordDO.java           # 观看记录DO
│   └── mysql/
│       ├── MovieMapper.java
│       └── MovieRecordMapper.java
├── client/
│   └── TMDBClient.java                  # TMDB客户端
└── constants/
    └── MovieErrorCodeConstants.java     # 错误码常量
```

### 6.2 关键实现点

1. **TMDB客户端**：
   - 封装HTTP请求
   - 处理API调用异常
   - 实现缓存机制
   - 数据映射（TMDB数据 -> DO对象）

2. **事务管理**：
   - 创建影视和记录时使用事务
   - 确保数据一致性

3. **权限校验**：
   - 使用 `UserContext.getUserId()` 获取当前用户
   - 更新/删除时校验记录归属

4. **数据转换**：
   - VO -> DO 转换
   - DO -> VO 转换
   - 使用 `BeanUtils` 工具类

5. **分页查询**：
   - 使用 `PageParam` 和 `PageResult`
   - 支持多条件查询
   - 使用 `LambdaQueryWrapperX` 构建查询条件

### 6.3 错误处理

**错误码定义**（示例）：
- `MOVIE_NOT_EXISTS`: 影视不存在
- `MOVIE_RECORD_NOT_EXISTS`: 观看记录不存在
- `MOVIE_RECORD_NOT_OWNER`: 无权操作该记录
- `TMDB_API_ERROR`: TMDB API调用失败
- `AI_TAG_GENERATE_ERROR`: AI标签生成失败

---

## 七、后续扩展方向

### 7.1 功能扩展

1. **推荐功能**：
   - 基于用户观看历史和标签推荐相似影视
   - 基于评分推荐高分影视

2. **统计分析**：
   - 观看统计（数量、时长、类型分布）
   - 评分分布
   - 时间线展示

3. **社交功能**：
   - 分享观看记录
   - 查看好友的观看记录（可选）

### 7.2 性能优化

1. **缓存优化**：
   - 影视详情缓存
   - 列表查询结果缓存
   - 标签生成结果缓存

2. **查询优化**：
   - 索引优化
   - 分页查询优化
   - 关联查询优化

---

## 八、开发检查清单

### 8.1 数据库

- [ ] 确认 `movie` 表结构
  - [ ] 添加 `tmdb_id` 字段（BIGINT，可空，用于关联TMDB数据）
  - [ ] 添加 `tmdb_id` 索引（idx_tmdb_id）
- [ ] 确认 `movie_record` 表结构
- [ ] 确认索引设计（user_id, movie_id, watch_status等）
- [ ] 确认唯一约束（user_id + movie_id）

**注意**：当前数据库初始化脚本中缺少 `tmdb_id` 字段，需要在实现时添加。

### 8.2 接口

- [ ] 搜索接口（TMDB）
- [ ] 创建接口（TMDB/手动）
- [ ] 更新接口
- [ ] 列表查询接口
- [ ] 详情查询接口
- [ ] AI标签生成接口
- [ ] 删除接口

### 8.3 业务逻辑

- [ ] 权限校验（只能操作自己的记录）
- [ ] 状态变更逻辑（自动更新watchDate）
- [ ] 数据创建逻辑（Movie + MovieRecord）
- [ ] 数据更新逻辑（部分更新）
- [ ] 数据查询逻辑（多维度筛选）

### 8.4 外部服务

- [ ] TMDB客户端实现
- [ ] TMDB数据映射
- [ ] 缓存机制
- [ ] 异常处理
- [ ] AI服务集成（可选）

### 8.5 测试

- [ ] 单元测试
- [ ] 集成测试
- [ ] 接口测试
- [ ] 异常场景测试

---

## 九、总结

影视模块是兴趣追踪系统的核心模块，主要功能包括：

1. **影视信息管理**：通过TMDB API或手动创建
2. **观看记录管理**：记录用户的观看状态、评分、进度等
3. **标签管理**：支持AI自动生成和手动编辑
4. **数据查询**：支持多维度查询和统计

**核心设计要点**：
- 影视信息（Movie）和观看记录（MovieRecord）分离设计
- 支持TMDB API自动填充，提升用户体验
- 完善的权限控制和数据校验
- 灵活的查询和筛选能力

**下一步**：
根据本文档的设计，开始实现具体的代码。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-XX

