# 混合方案架构说明

## 一、架构设计

### 1.1 设计模式

采用**适配器模式（Adapter Pattern）**和**策略模式（Strategy Pattern）**：

```
MovieDataService (统一服务层)
    ├── TMDBProvider (主要数据源)
    └── DomesticProvider (备选数据源)
```

### 1.2 核心组件

1. **MovieDataProvider**（接口）
   - 定义统一的数据提供者接口
   - 所有数据源都实现此接口

2. **TMDBProvider**（实现）
   - TMDB API 的实现
   - 作为主要数据源

3. **DomesticProvider**（实现）
   - 国内 API 的实现
   - 作为备选数据源

4. **MovieDataService**（服务层）
   - 实现自动切换逻辑
   - 优先使用 TMDB，失败时自动切换到国内 API

## 二、工作流程

### 2.1 自动切换流程

```
1. 用户请求搜索影视
   ↓
2. MovieDataService 尝试使用 TMDBProvider
   ↓
3. 如果成功 → 返回结果
   ↓
4. 如果失败 → 自动切换到 DomesticProvider
   ↓
5. 如果成功 → 返回结果
   ↓
6. 如果失败 → 抛出异常（所有数据源都不可用）
```

### 2.2 优先级

- **第一优先级**：豆瓣 API（国内服务器友好，访问速度快）
- **第二优先级**：TMDB API（数据质量更高，作为备选）

## 三、配置说明

### 3.1 application.yml 配置

```yaml
# TMDB API 配置（主要数据源）
tmdb:
  api:
    read-access-token: your-token
    # ... 其他配置

# 国内 API 配置（备选数据源）
domestic:
  api:
    enabled: true   # 设置为 true 启用国内 API
    type: wmdb      # API 类型
    base-url: ""    # API 基础URL
    api-key: ""     # API Key（如果需要）
```

### 3.2 启用国内 API

1. 在 `application.yml` 中设置 `domestic.api.enabled=true`
2. 配置国内 API 的具体信息（base-url、api-key 等）
3. 重启应用

## 四、优势

### 4.1 高可用性

- ✅ **自动降级**：TMDB 不可用时自动切换到国内 API
- ✅ **无缝切换**：用户无感知，自动处理
- ✅ **容错性强**：单个数据源失败不影响整体功能

### 4.2 部署友好

- ✅ **国内服务器友好**：部署到国内服务器时，如果 TMDB 无法访问，自动使用国内 API
- ✅ **无需手动切换**：根据网络环境自动选择最佳数据源
- ✅ **配置灵活**：可以通过配置启用/禁用国内 API

### 4.3 可维护性

- ✅ **统一接口**：所有数据源使用统一接口，易于扩展
- ✅ **代码清晰**：职责分离，易于理解和维护
- ✅ **易于扩展**：可以轻松添加新的数据源

## 五、使用场景

### 5.1 开发环境

- 本地开发：优先使用 TMDB（如果网络可用）
- 如果 TMDB 无法访问，自动切换到国内 API

### 5.2 生产环境

- **国内服务器**：
  - 如果 TMDB 无法访问 → 自动使用国内 API
  - 如果 TMDB 可以访问 → 优先使用 TMDB

- **国外服务器**：
  - 优先使用 TMDB
  - 国内 API 作为备选

## 六、后续扩展

### 6.1 实现国内 API

当前 `DomesticProvider` 是占位实现，需要根据选择的国内 API 实现具体逻辑：

1. **选择国内 API**（如 WMDB API）
2. **实现搜索接口**
3. **实现详情接口**
4. **数据格式转换**（将国内 API 的响应转换为统一的 DTO）

### 6.2 添加更多数据源

可以轻松添加新的数据源：

1. 创建新的 Provider 实现 `MovieDataProvider` 接口
2. 在 `MovieDataService` 中添加到提供者列表
3. 配置优先级

## 七、注意事项

1. **数据一致性**：不同数据源的数据格式可能不同，需要统一转换
2. **ID 映射**：不同数据源使用不同的 ID，需要处理 ID 映射
3. **图片 URL**：不同数据源的图片 URL 格式可能不同
4. **性能考虑**：自动切换会增加响应时间，建议添加缓存

## 八、总结

混合方案的优势：
- ✅ **高可用性**：自动降级，保证服务可用
- ✅ **部署友好**：适应不同网络环境
- ✅ **易于维护**：统一接口，易于扩展
- ✅ **用户无感知**：自动切换，无需手动操作

当前实现：
- ✅ 架构已搭建完成
- ✅ 自动切换逻辑已实现
- ⚠️ 国内 API 具体实现待完成（占位实现）

下一步：
1. 选择合适的国内 API（如 WMDB API）
2. 实现 `DomesticProvider` 的具体逻辑
3. 测试自动切换功能

