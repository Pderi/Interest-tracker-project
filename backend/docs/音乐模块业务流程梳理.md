# 音乐模块业务流程梳理

## 📋 文档说明

本文档详细梳理音乐模块的核心业务流程，包括数据模型、业务规则、接口设计和实现要点。本文档作为开发前的设计参考，不涉及具体代码实现。

**版本**: v1.0  
**创建日期**: 2025-12-19  
**状态**: 设计阶段

**重要说明**：
- 音乐模块以**专辑**为单位进行管理，而不是单首歌曲
- 暂时不考虑API集成（如Last.fm），只支持手动添加
- 后续可扩展API集成功能

---

## 一、业务概述

### 1.1 核心功能

音乐模块是兴趣追踪系统的核心模块之一，主要功能包括：

1. **专辑信息管理**：手动创建专辑信息（专辑名、艺术家、发行年份等）
2. **听歌记录管理**：记录用户的听歌状态、评分、听歌日期、评价等
3. **标签管理**：支持AI自动生成标签和手动编辑标签（后续扩展）
4. **数据查询**：支持多维度查询和统计

### 1.2 业务价值

- **个性化管理**：支持个人评分、标签、评价等个性化信息
- **数据沉淀**：积累用户的听歌数据，为后续推荐和分析提供基础
- **简单易用**：手动添加方式简单直接，无需依赖外部API

---

## 二、数据模型设计

### 2.1 核心实体

#### 2.1.1 专辑实体（Album）

**表名**: `album`

**字段说明**：

| 字段 | 类型 | 说明 | 来源 |
|------|------|------|------|
| id | BIGINT | 主键ID | 自增 |
| title | VARCHAR(255) | 专辑名称 | 手动 |
| artist | VARCHAR(255) | 艺术家/乐队 | 手动 |
| release_year | INT | 发行年份 | 手动 |
| genre | VARCHAR(128) | 音乐类型（摇滚、流行等，逗号分隔） | 手动 |
| description | TEXT | 专辑简介 | 手动 |
| cover_url | VARCHAR(512) | 封面URL | 手动 |
| total_tracks | INT | 总曲目数 | 手动 |
| duration | INT | 总时长（秒） | 手动 |
| creator | VARCHAR(64) | 创建者 | 系统 |
| create_time | DATETIME | 创建时间 | 系统 |
| updater | VARCHAR(64) | 更新者 | 系统 |
| update_time | DATETIME | 更新时间 | 系统 |
| deleted | TINYINT | 是否删除：0-否 1-是 | 系统 |

**业务规则**：
- `title` 和 `artist` 为必填字段
- `release_year`、`genre`、`cover_url` 等为可选字段，可后续补充
- 同一用户下，相同 `title` + `artist` 的专辑应该唯一（避免重复添加）

#### 2.1.2 听歌记录实体（AlbumRecord）

**表名**: `album_record`

**字段说明**：

| 字段 | 类型 | 说明 | 来源 |
|------|------|------|------|
| id | BIGINT | 主键ID | 自增 |
| user_id | BIGINT | 用户ID | 系统 |
| album_id | BIGINT | 专辑ID | 必填 |
| listen_status | TINYINT | 听歌状态：1-想听 2-在听 3-已听 4-弃听 | 用户 |
| personal_rating | DECIMAL(3,1) | 个人评分（0-10） | 用户 |
| listen_date | DATE | 听歌日期 | 用户 |
| listen_count | INT | 听歌次数 | 用户 |
| comment | TEXT | 评价 | 用户 |
| tags | VARCHAR(512) | 标签（逗号分隔） | AI/用户 |
| creator | VARCHAR(64) | 创建者 | 系统 |
| create_time | DATETIME | 创建时间 | 系统 |
| updater | VARCHAR(64) | 更新者 | 系统 |
| update_time | DATETIME | 更新时间 | 系统 |
| deleted | TINYINT | 是否删除：0-否 1-是 | 系统 |

**业务规则**：
- `user_id` 和 `album_id` 组合唯一（一个用户对一个专辑只能有一条记录）
- `listen_status` 默认为 1（想听）
- `personal_rating` 支持 0.5 步长（如 8.5）
- `listen_count` 用于记录听歌次数，可手动更新

### 2.2 数据关系

```
用户 (User)
  └── 1:N ──> 听歌记录 (AlbumRecord)
                └── N:1 ──> 专辑 (Album)
```

**关系说明**：
- 一个用户可以有多个听歌记录
- 一个专辑可以被多个用户记录
- 一个听歌记录关联一个专辑和一个用户

---

## 三、核心业务流程

### 3.1 添加专辑记录流程

#### 3.1.1 手动创建

**流程步骤**：

```
1. 用户点击"添加记录"按钮
   ↓
2. 前端显示手动输入表单
   ↓
3. 用户填写基本信息（title、artist必填，其他可选）
   ↓
4. 前端调用创建接口 POST /api/music/albums
   Body: { title: "xxx", artist: "xxx", ... }
   ↓
5. 后端校验必填字段（title、artist）
   ↓
6. 检查是否已存在相同专辑（title + artist）
   ↓
7. 创建Album记录
   ↓
8. 创建AlbumRecord记录（关联当前用户）
   ↓
9. 返回记录ID
```

**关键点**：
- 手动创建时所有字段都来自用户输入
- 必填字段校验：`title`、`artist`
- 可选字段可以后续补充
- 创建Album和AlbumRecord是原子操作（事务）

### 3.2 更新听歌记录流程

**流程步骤**：

```
1. 用户查看自己的听歌记录
   ↓
2. 用户编辑记录（状态、评分、听歌日期、评价、标签等）
   ↓
3. 前端调用更新接口 PUT /api/music/albums/records/{id}
   Body: { listenStatus: 3, personalRating: 8.5, ... }
   ↓
4. 后端校验记录归属（只能更新自己的记录）
   ↓
5. 更新AlbumRecord记录
   ↓
6. 返回成功
```

**业务规则**：
- 只能更新自己的记录（越权校验）
- 状态变更时，可以自动更新 `listen_date`（如：状态改为"已听"时，自动设置为当前日期）
- 评分支持 0.5 步长

### 3.3 生成AI标签流程（后续扩展）

**流程步骤**：

```
1. 用户点击"生成标签"按钮
   ↓
2. 前端调用接口 POST /api/music/albums/{id}/ai-tags
   ↓
3. 后端获取专辑信息（title、artist、description、genre等）
   ↓
4. 调用AI服务（Hugging Face / Gemini）
   输入：专辑信息
   输出：3-5个标签
   ↓
5. 更新AlbumRecord的tags字段
   ↓
6. 返回生成的标签列表
```

**降级方案**：
- AI调用失败时，返回错误码，提示用户手动添加
- 支持重试机制
- 可以缓存AI生成结果（相同专辑信息生成相同标签）

### 3.4 查询列表流程

**流程步骤**：

```
1. 用户进入音乐列表页面
   ↓
2. 前端调用列表接口 GET /api/music/albums?pageNo=1&pageSize=10&status=3
   ↓
3. 后端查询AlbumRecord（关联Album）
   条件：
   - user_id = 当前用户
   - listen_status = 3（已听）
   ↓
4. 分页返回结果
   ↓
5. 前端展示列表
```

**查询维度**：
- 按听歌状态筛选（想听/在听/已听/弃听）
- 按艺术家筛选
- 按音乐类型筛选
- 按标签筛选
- 按时间排序（创建时间/听歌日期）
- 按评分排序
- 关键词搜索（专辑名、艺术家）

### 3.5 查看详情流程

**流程步骤**：

```
1. 用户点击列表中的专辑
   ↓
2. 前端调用详情接口 GET /api/music/albums/{id}
   ↓
3. 后端查询Album和AlbumRecord
   ↓
4. 组装返回数据（包含专辑信息和用户记录）
   ↓
5. 前端展示详情页
```

**返回数据包含**：
- 专辑基本信息（Album）
- 用户听歌记录（AlbumRecord）
- 关联信息（如：同艺术家推荐，可选）

---

## 四、接口设计

### 4.1 创建专辑记录接口

**接口**: `POST /api/music/albums`

**功能**: 创建专辑记录（手动）

**请求体**:
```json
{
  "title": "Abbey Road",           // 必填：专辑名称
  "artist": "The Beatles",          // 必填：艺术家
  "releaseYear": 1969,             // 可选：发行年份
  "genre": "摇滚,流行",             // 可选：音乐类型（逗号分隔）
  "description": "经典专辑...",     // 可选：简介
  "coverUrl": "https://...",        // 可选：封面URL
  "totalTracks": 17,               // 可选：总曲目数
  "duration": 2556,                // 可选：总时长（秒）
  "listenStatus": 1,               // 可选，默认1（想听）
  "personalRating": null,          // 可选
  "tags": null,                    // 可选
  "comment": null                  // 可选
}
```

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "albumId": 1,
    "recordId": 1
  }
}
```

**业务规则**:
- 创建Album和AlbumRecord是原子操作
- 如果Album已存在（相同title + artist），则复用，只创建AlbumRecord
- 必填字段：`title`、`artist`

### 4.2 更新听歌记录接口

**接口**: `PUT /api/music/albums/records/{id}`

**功能**: 更新听歌记录

**请求体**:
```json
{
  "listenStatus": 3,               // 可选
  "personalRating": 8.5,          // 可选
  "listenDate": "2025-01-15",     // 可选
  "listenCount": 10,              // 可选
  "comment": "很好听",             // 可选
  "tags": "摇滚,经典"              // 可选
}
```

**业务规则**:
- 只能更新自己的记录
- 状态改为"已听"时，如果 `listenDate` 为空，自动设置为当前日期
- 所有字段都是可选的（部分更新）

### 4.3 查询列表接口

**接口**: `GET /api/music/albums`

**功能**: 查询用户的专辑记录列表

**请求参数**:
- `pageNo` (Integer, 必填): 页码
- `pageSize` (Integer, 必填): 每页数量
- `status` (Integer, 可选): 听歌状态（1-想听 2-在听 3-已听 4-弃听）
- `artist` (String, 可选): 艺术家筛选
- `genre` (String, 可选): 音乐类型筛选
- `tag` (String, 可选): 标签筛选
- `keyword` (String, 可选): 关键词搜索（专辑名、艺术家）
- `sort` (String, 可选): 排序字段（ctime-创建时间, listenDate-听歌日期, rating-评分）

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "total": 100,
    "list": [
      {
        "recordId": 1,
        "albumId": 1,
        "title": "Abbey Road",
        "artist": "The Beatles",
        "releaseYear": 1969,
        "coverUrl": "https://...",
        "listenStatus": 3,
        "personalRating": 8.5,
        "listenDate": "2025-01-15",
        "listenCount": 10,
        "tags": ["摇滚", "经典"],
        "createTime": "2025-01-10 10:00:00"
      }
    ]
  }
}
```

### 4.4 查看详情接口

**接口**: `GET /api/music/albums/{id}`

**功能**: 查看专辑详情（包含用户记录）

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "album": {
      "id": 1,
      "title": "Abbey Road",
      "artist": "The Beatles",
      "releaseYear": 1969,
      "genre": "摇滚,流行",
      "description": "简介...",
      "coverUrl": "https://...",
      "totalTracks": 17,
      "duration": 2556
    },
    "record": {
      "id": 1,
      "listenStatus": 3,
      "personalRating": 8.5,
      "listenDate": "2025-01-15",
      "listenCount": 10,
      "comment": "很好听",
      "tags": ["摇滚", "经典"]
    }
  }
}
```

### 4.5 生成AI标签接口（后续扩展）

**接口**: `POST /api/music/albums/{id}/ai-tags`

**功能**: 为专辑生成AI标签

**响应数据**:
```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "tags": ["摇滚", "经典", "60年代", "英国"]
  }
}
```

**业务规则**:
- AI调用失败时返回错误码，提示手动添加
- 生成的标签会自动更新到AlbumRecord
- 支持重试

### 4.6 删除记录接口

**接口**: `DELETE /api/music/albums/records/{id}`

**功能**: 删除听歌记录（软删除）

**业务规则**:
- 只能删除自己的记录
- 软删除（设置deleted=1）
- 删除记录不影响Album实体

---

## 五、业务规则总结

### 5.1 数据创建规则

1. **专辑创建**：
   - 手动创建：必须提供 `title` 和 `artist`
   - 同一用户下，相同 `title` + `artist` 的专辑应该唯一（避免重复添加）

2. **记录创建**：
   - 创建专辑时自动创建听歌记录
   - 默认状态为"想听"（listenStatus=1）
   - 用户ID从当前登录用户获取

### 5.2 数据更新规则

1. **权限控制**：
   - 只能更新自己的记录
   - 管理员可以管理所有记录（后续扩展）

2. **状态变更**：
   - 状态改为"已听"时，如果 `listenDate` 为空，自动设置为当前日期
   - 状态改为"弃听"时，可以记录原因（comment字段）

3. **评分规则**：
   - 评分范围：0-10
   - 支持 0.5 步长（如 8.5）

### 5.3 数据查询规则

1. **权限控制**：
   - 只能查询自己的记录
   - 列表查询自动过滤 `deleted=1` 的记录

2. **排序规则**：
   - 默认按创建时间倒序
   - 支持按听歌日期、评分排序

3. **筛选规则**：
   - 支持多维度筛选（状态、艺术家、类型、标签、关键词）
   - 筛选条件可以组合使用

### 5.4 外部服务调用规则（后续扩展）

1. **API集成**（后续扩展）：
   - 可集成 Last.fm、Spotify 等音乐API
   - 搜索结果缓存1小时
   - 详情信息缓存24小时
   - 调用失败时允许手动创建

2. **AI服务**（后续扩展）：
   - 优先使用免费AI（Hugging Face / Gemini）
   - 调用失败时提示手动添加
   - 支持重试机制
   - 可以缓存生成结果

---

## 六、技术实现要点

### 6.1 模块结构

```
module/music/
├── controller/
│   └── app/
│       ├── MusicAppController.java      # 音乐管理接口
│       └── vo/                         # VO对象
│           ├── AlbumCreateReqVO.java
│           ├── AlbumRecordUpdateReqVO.java
│           ├── AlbumPageReqVO.java
│           ├── AlbumPageRespVO.java
│           └── AlbumRespVO.java
├── service/
│   ├── AlbumService.java                # 专辑服务接口
│   ├── AlbumRecordService.java          # 听歌记录服务接口
│   └── impl/
│       ├── AlbumServiceImpl.java
│       └── AlbumRecordServiceImpl.java
├── dal/
│   ├── dataobject/
│   │   ├── AlbumDO.java                 # 专辑DO
│   │   └── AlbumRecordDO.java           # 听歌记录DO
│   └── mysql/
│       ├── AlbumMapper.java
│       └── AlbumRecordMapper.java
├── enums/
│   └── ListenStatusEnum.java            # 听歌状态枚举
└── constants/
    └── MusicErrorCodeConstants.java     # 错误码常量
```

### 6.2 关键实现点

1. **事务管理**：
   - 创建专辑和记录时使用事务
   - 确保数据一致性

2. **权限校验**：
   - 使用 `UserContext.getUserId()` 获取当前用户
   - 更新/删除时校验记录归属

3. **数据转换**：
   - VO -> DO 转换
   - DO -> VO 转换
   - 使用 `BeanUtils` 工具类

4. **分页查询**：
   - 使用 `PageParam` 和 `PageResult`
   - 支持多条件查询
   - 使用 `LambdaQueryWrapperX` 构建查询条件

5. **唯一性校验**：
   - 创建专辑时检查 `title` + `artist` 是否已存在
   - 创建记录时检查 `user_id` + `album_id` 是否已存在

### 6.3 错误处理

**错误码定义**（示例）：
- `ALBUM_NOT_EXISTS`: 专辑不存在
- `ALBUM_RECORD_NOT_EXISTS`: 听歌记录不存在
- `ALBUM_RECORD_NOT_OWNER`: 无权操作该记录
- `ALBUM_ALREADY_EXISTS`: 专辑已存在（相同title + artist）
- `ALBUM_RECORD_ALREADY_EXISTS`: 听歌记录已存在

---

## 七、后续扩展方向

### 7.1 功能扩展

1. **API集成**：
   - 集成 Last.fm API 搜索专辑
   - 集成 Spotify API 获取专辑信息
   - 自动填充专辑信息（封面、简介等）

2. **统计分析**：
   - 听歌统计（数量、时长、艺术家分布）
   - 评分分布
   - 时间线展示

3. **社交功能**：
   - 分享听歌记录
   - 查看好友的听歌记录（可选）

### 7.2 性能优化

1. **缓存优化**：
   - 专辑详情缓存
   - 列表查询结果缓存
   - 标签生成结果缓存

2. **查询优化**：
   - 索引优化
   - 分页查询优化
   - 关联查询优化

---

## 八、开发检查清单

### 8.1 数据库

- [ ] 确认 `album` 表结构
  - [ ] 添加 `title` 字段（VARCHAR(255)，必填）
  - [ ] 添加 `artist` 字段（VARCHAR(255)，必填）
  - [ ] 添加 `release_year` 字段（INT，可选）
  - [ ] 添加 `genre` 字段（VARCHAR(128)，可选）
  - [ ] 添加 `cover_url` 字段（VARCHAR(512)，可选）
  - [ ] 添加 `total_tracks` 字段（INT，可选）
  - [ ] 添加 `duration` 字段（INT，可选）
  - [ ] 添加索引（idx_title, idx_artist, idx_release_year）
- [ ] 确认 `album_record` 表结构
  - [ ] 添加 `user_id` 字段（BIGINT，必填）
  - [ ] 添加 `album_id` 字段（BIGINT，必填）
  - [ ] 添加 `listen_status` 字段（TINYINT，默认1）
  - [ ] 添加 `personal_rating` 字段（DECIMAL(3,1)，可选）
  - [ ] 添加 `listen_date` 字段（DATE，可选）
  - [ ] 添加 `listen_count` 字段（INT，可选）
  - [ ] 添加唯一约束（uk_user_album: user_id + album_id）
  - [ ] 添加索引（idx_user_id, idx_album_id, idx_listen_status, idx_listen_date）

### 8.2 接口

- [ ] 创建接口（手动）
- [ ] 更新接口
- [ ] 列表查询接口
- [ ] 详情查询接口
- [ ] 删除接口
- [ ] AI标签生成接口（后续扩展）

### 8.3 业务逻辑

- [ ] 权限校验（只能操作自己的记录）
- [ ] 状态变更逻辑（自动更新listenDate）
- [ ] 数据创建逻辑（Album + AlbumRecord）
- [ ] 数据更新逻辑（部分更新）
- [ ] 数据查询逻辑（多维度筛选）
- [ ] 唯一性校验（title + artist）

### 8.4 外部服务（后续扩展）

- [ ] Last.fm客户端实现（后续）
- [ ] Last.fm数据映射（后续）
- [ ] 缓存机制（后续）
- [ ] 异常处理（后续）
- [ ] AI服务集成（后续）

### 8.5 测试

- [ ] 单元测试
- [ ] 集成测试
- [ ] 接口测试
- [ ] 异常场景测试

---

## 九、总结

音乐模块是兴趣追踪系统的核心模块之一，主要功能包括：

1. **专辑信息管理**：手动创建专辑信息
2. **听歌记录管理**：记录用户的听歌状态、评分、日期等
3. **标签管理**：支持AI自动生成和手动编辑（后续扩展）
4. **数据查询**：支持多维度查询和统计

**核心设计要点**：
- 专辑信息（Album）和听歌记录（AlbumRecord）分离设计
- 暂时只支持手动添加，后续可扩展API集成
- 完善的权限控制和数据校验
- 灵活的查询和筛选能力

**下一步**：
根据本文档的设计，开始实现具体的代码。

---

**文档版本**: v1.0  
**最后更新**: 2025-12-19

