# 部署配置最佳实践

## 一、问题分析

### 1.1 部署场景

- **国内服务器**：无法直接访问 TMDB API（需要 VPN/代理）
- **国外服务器**：可以访问 TMDB API
- **混合方案优势**：自动切换，无需手动配置

### 1.2 用户使用场景

- **国内用户**：访问国内服务器 → 服务器使用豆瓣 API（自动）
- **国外用户**：访问国外服务器 → 服务器使用 TMDB API（自动）
- **自动适配**：根据网络环境自动选择最佳数据源

## 二、部署配置方案

### 2.1 方案一：国内服务器（推荐）

**配置**：启用豆瓣 API 作为主要备选

```yaml
# application.yml 或 application-prod.yml
tmdb:
  api:
    read-access-token: your-token  # 配置 TMDB Token（尝试使用）
    # 如果无法访问，会自动切换到豆瓣

domestic:
  api:
    enabled: true   # 启用豆瓣 API 作为备选
    type: douban
```

**优势**：
- ✅ **无需 VPN**：服务器不需要配置 VPN 或代理
- ✅ **自动切换**：TMDB 失败时自动使用豆瓣
- ✅ **用户无感知**：自动处理，用户无需关心
- ✅ **部署简单**：只需配置 API Token，无需网络配置

### 2.2 方案二：国外服务器

**配置**：主要使用 TMDB，豆瓣作为备选

```yaml
tmdb:
  api:
    read-access-token: your-token  # TMDB Token

domestic:
  api:
    enabled: true   # 启用豆瓣作为备选（可选）
    type: douban
```

**优势**：
- ✅ **数据质量高**：优先使用 TMDB
- ✅ **自动降级**：如果 TMDB 出现问题，自动切换到豆瓣

### 2.3 方案三：混合部署（最佳实践）

**配置**：同时启用 TMDB 和豆瓣

```yaml
tmdb:
  api:
    read-access-token: your-token

domestic:
  api:
    enabled: true   # 启用豆瓣 API
    type: douban
```

**工作流程**：
1. 优先尝试豆瓣 API（国内服务器友好，访问速度快）
2. 如果失败，自动切换到 TMDB
3. 用户无感知，自动处理

## 三、不同部署场景的配置

### 3.1 场景一：国内服务器，供国内用户使用

**推荐配置**：
```yaml
tmdb:
  api:
    read-access-token: your-token  # 尝试使用 TMDB（如果网络可用）

domestic:
  api:
    enabled: true   # 必须启用，作为主要备选
    type: douban
```

**说明**：
- 服务器可能无法访问 TMDB → 自动使用豆瓣
- 用户访问速度快（国内 API）
- 无需配置 VPN 或代理

### 3.2 场景二：国外服务器，供全球用户使用

**推荐配置**：
```yaml
tmdb:
  api:
    read-access-token: your-token  # 主要使用 TMDB

domestic:
  api:
    enabled: true   # 启用作为备选（可选）
    type: douban
```

**说明**：
- 服务器可以访问 TMDB → 优先使用 TMDB
- 如果 TMDB 出现问题，自动切换到豆瓣
- 无需额外配置

### 3.3 场景三：容器化部署（Docker/K8s）

**推荐配置**：
```yaml
# 使用环境变量，无需修改配置文件
tmdb:
  api:
    read-access-token: ${TMDB_READ_ACCESS_TOKEN}

domestic:
  api:
    enabled: ${DOMESTIC_API_ENABLED:true}  # 默认启用
    type: douban
```

**部署命令**：
```bash
docker run -e TMDB_READ_ACCESS_TOKEN=xxx \
           -e DOMESTIC_API_ENABLED=true \
           your-app
```

## 四、最佳实践建议

### 4.1 推荐配置（适用于所有场景）

```yaml
# 生产环境配置（application-prod.yml）
tmdb:
  api:
    read-access-token: ${TMDB_READ_ACCESS_TOKEN}  # 从环境变量读取

domestic:
  api:
    enabled: true   # 始终启用豆瓣 API 作为备选
    type: douban
```

**优势**：
- ✅ **适应性强**：无论服务器在哪里都能工作
- ✅ **高可用性**：自动降级，保证服务可用
- ✅ **部署简单**：无需配置 VPN 或代理
- ✅ **用户友好**：用户无感知，自动处理

### 4.2 环境变量配置（推荐）

**开发环境**（`application-dev.yml`）：
```yaml
tmdb:
  api:
    read-access-token: your-dev-token

domestic:
  api:
    enabled: true
```

**生产环境**（`application-prod.yml`）：
```yaml
tmdb:
  api:
    read-access-token: ${TMDB_READ_ACCESS_TOKEN}

domestic:
  api:
    enabled: ${DOMESTIC_API_ENABLED:true}  # 默认启用
```

**部署时**：
```bash
# 设置环境变量
export TMDB_READ_ACCESS_TOKEN=your-token
export DOMESTIC_API_ENABLED=true

# 启动应用
java -jar your-app.jar
```

## 五、部署检查清单

### 5.1 部署前检查

- [ ] TMDB Token 已配置（从环境变量或配置文件）
- [ ] 豆瓣 API 已启用（`domestic.api.enabled=true`）
- [ ] 测试搜索功能（验证自动切换）
- [ ] 测试详情获取（验证 ID 映射）

### 5.2 部署后验证

1. **测试搜索**：
   ```bash
   curl "http://your-server/api/movies/search?keyword=测试&page=1"
   ```

2. **查看日志**：
   - 确认使用了哪个数据源（TMDB 或豆瓣）
   - 确认自动切换是否正常工作

3. **监控告警**：
   - 监控 API 调用成功率
   - 监控自动切换频率

## 六、常见问题

### Q1: 服务器在国内，需要配置 VPN 吗？

**A**: **不需要**。启用豆瓣 API 后，如果 TMDB 无法访问，会自动切换到豆瓣，无需 VPN。

### Q2: 如何知道当前使用的是哪个数据源？

**A**: 查看应用日志，会显示使用的数据源：
```
使用 Douban API 搜索成功: keyword=xxx
或
使用 TMDB 搜索成功: keyword=xxx
```

### Q3: 可以只使用豆瓣 API 吗？

**A**: 可以，但不推荐。建议同时启用两个数据源，提高可用性。

### Q4: 部署到不同环境需要修改配置吗？

**A**: 不需要。使用环境变量配置，不同环境只需设置不同的环境变量即可。

## 七、总结

### 7.1 混合方案的优势

✅ **部署简单**：
- 无需配置 VPN 或代理
- 只需配置 API Token
- 适应不同网络环境

✅ **高可用性**：
- 自动降级，保证服务可用
- 单个数据源失败不影响整体功能

✅ **用户友好**：
- 用户无感知，自动处理
- 无需手动切换

### 7.2 推荐配置

**适用于所有场景的配置**：
```yaml
tmdb:
  api:
    read-access-token: ${TMDB_READ_ACCESS_TOKEN}

domestic:
  api:
    enabled: true   # 始终启用
    type: douban
```

**部署时**：
1. 设置 `TMDB_READ_ACCESS_TOKEN` 环境变量
2. 启动应用
3. 完成！无需其他配置

### 7.3 结论

**混合方案完美解决了部署问题**：
- ✅ 国内服务器 → 自动使用豆瓣 API
- ✅ 国外服务器 → 自动使用 TMDB API
- ✅ 无需 VPN 配置
- ✅ 无需手动切换
- ✅ 部署简单，维护方便

**这就是混合方案的核心价值**：一次配置，到处运行！

