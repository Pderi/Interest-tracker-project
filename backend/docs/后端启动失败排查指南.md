## 后端启动失败排查指南（Spring Boot / MyBatis-Plus 通用）

> 适用范围：  
> - Spring Boot 3.x（Spring Framework 6.x）  
> - MyBatis / MyBatis-Plus 项目  
> - 启动阶段直接 `Application run failed` 的问题  

---

## 一、看日志前两屏，先搞清「失败在哪一层」

启动失败时，日志最后通常有：

- `Application run failed`  
- 上面几行是关键异常堆栈，常见模式：
  - **类版本不兼容**：`Unsupported class file major version xx`
  - **Bean 类型/定义问题**：`BeanNotOfRequiredTypeException` / `BeanDefinitionStoreException`
  - **属性类型不匹配**：`Invalid value type for attribute 'xxx'`

建议每次都**从最后一段 ERROR 开始往上看 10～30 行**，先确认是哪一类。

---

## 二、JDK 与 Spring / Boot 版本兼容问题

### 2.1 典型报错

```text
Caused by: java.lang.IllegalArgumentException: Unsupported class file major version 66
```

- `major version 66` = Java 22  
- `major version 65` = Java 21  
- `major version 64` = Java 20  

原因：**代码用高版本 JDK 编译，但当前 Spring / ASM 还不支持解析这么新的 `.class`**。

### 2.2 处理步骤

1. **在根 `backend/pom.xml` 统一设置编译目标：**

```xml
<properties>
    <!-- 推荐：Spring Boot 3.x 官方支持最佳的是 Java 17 -->
    <java.version>17</java.version>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>
    ...
</properties>
```

2. **IDE 的 Project SDK 也要对齐**：

- IntelliJ / IDEA 中设置 Project SDK / Language level 为 **17**（或与上述一致）。

3. **重新全量编译再启动**：

```bash
cd backend
mvn clean install
cd interest-tracker-server
mvn spring-boot:run
```

---

## 三、Spring / MyBatis-Plus 版本组合问题

### 3.1 典型症状一：FactoryBean 属性类型异常

```text
java.lang.IllegalArgumentException: Invalid value type for attribute 'factoryBeanObjectType': java.lang.String
    at org.springframework.beans.factory.support.FactoryBeanRegistrySupport.getTypeForFactoryBeanFromAttributes(...)
```

含义：  
某个 `FactoryBean`（通常是 Mapper 相关）在 `BeanDefinition` 上把 `factoryBeanObjectType` 这个内部属性写成了 **String**，  
而 Spring 6.1+ 在启动时检查到了类型不对，直接抛异常。

### 3.2 典型症状二：Runner 类型不兼容

```text
Bean named 'ddlApplicationRunner' is expected to be of type 'org.springframework.boot.Runner' 
but was actually of type 'org.springframework.beans.factory.support.NullBean'
```

说明 Spring Boot 和第三方 Starter（如 MyBatis-Plus）之间的 Runner 抽象版本不匹配。

### 3.3 建议的「安全组合」

如果没有强依赖最新的 Spring 功能，推荐采用 **官方已验证的版本搭配**：

- **Spring Boot**：`3.0.10`（对应 Spring Framework 6.0.x）  
- **MyBatis-Plus**：`3.5.3.2`  
- **MyBatis Spring Boot Starter**：**使用 MyBatis-Plus 自带的即可，一般不单独覆盖版本**

对应 `backend/pom.xml` 关键配置：

```xml
<properties>
    <spring-boot.version>3.0.10</spring-boot.version>
    <mybatis-plus.version>3.5.3.2</mybatis-plus.version>
    ...
</properties>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>
        ...
    </dependencies>
</dependencyManagement>
```

Server 模块 `backend/interest-tracker-server/pom.xml` 中只需要：

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
</dependency>
```

> 尽量**不要同时手动引入另一个 `mybatis-spring-boot-starter` 去覆盖版本**，容易引入新的兼容问题，除非已经明确查证需要覆盖，且版本配套。

---

## 四、排查 Spring Boot 启动失败的通用步骤

### 步骤 1：锁定真正的异常

1. 找到日志中第一次出现的：
   - `Application run failed`
   - 上面的 `Caused by:`、`IllegalArgumentException`、`BeanCreationException` 等
2. 复制这几行进行分析，而不是只看 Condition Report。

### 步骤 2：先排除「环境 / 版本」问题

按顺序检查：

1. **JDK 版本 vs Spring Boot 版本**
   - Spring Boot 3.x 要求 **JDK 17+**，建议直接用 JDK 17。
   - 避免用未来版本（20/21/22）配老的 Spring / ASM。

2. **Spring Boot vs MyBatis-Plus 版本**
   - 参考 MyBatis-Plus 官方文档中的「与 Spring Boot 版本对应表」。
   - 当出现 `factoryBeanObjectType`、`Runner` 类型不匹配之类的错误时，优先考虑按「安全组合」回退。

3. **清理再构建**

```bash
cd backend
mvn clean install
cd interest-tracker-server
mvn spring-boot:run
```

### 步骤 3：再排查业务 Bean / 配置错误

在环境和版本没问题后，如果还报错，通常就是：

- 某个 `@Configuration` / `@Component` 写错类型或构造方法；
- Bean 循环依赖；
- 某些 `@Value` / 配置属性缺失等。

此时根据最后的 `Caused by`，直接定位到具体类和字段即可，一般和框架兼容性无关。

---

## 五、快速决策表

| 现象 | 优先检查 | 可能的解决动作 |
|------|----------|----------------|
| `Unsupported class file major version xx` | JDK 与 `<java.version>` | 把编译目标和 IDE SDK 统一为 17，重新 `mvn clean install` |
| `Invalid value type for attribute 'factoryBeanObjectType'` | Spring / MyBatis 版本 | 使用 Spring Boot 3.0.x + MP 3.5.3.2 组合，避免 Spring 6.1 的严格校验坑 |
| `BeanNotOfRequiredTypeException`，涉及 `ddlApplicationRunner` 等 | Boot 与 MyBatis-Plus 版本 | 使用官方配套版本（如 3.0.10 + 3.5.3.2），避免 3.1/3.2 与旧 Starter 混搭 |
| 日志大量 Condition Report，看不到异常细节 | 日志级别 | 在 `application.yml` 临时加 `debug: true`，定位完问题后改回 `false` |

---

## 六、小结

1. **先看版本，再看代码**：启动期的大部分诡异异常，根源是「JDK / Spring Boot / MyBatis 版本组合不对」。  
2. **锁定一套「安全组合」作为基线**：目前本项目采用 `Spring Boot 3.0.10 + MyBatis-Plus 3.5.3.2 + JDK 17`，遇到问题先回到这套基线。  
3. **改完版本一定要 `mvn clean install` 一次**，避免旧的 `.class` 还留在 `target` 里干扰排查。  

只要按照这份文档先把「环境 + 版本」理顺，再去看具体业务异常，基本都能在可控范围内快速解决启动失败问题。  


