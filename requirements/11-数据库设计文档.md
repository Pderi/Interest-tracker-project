# 数据库设计文档（DDD）

## 1. 文档信息
- 文档名称：数据库设计文档（DDD）
- 版本号：v1.0.0
- 创建日期：2025-12-09
- 最后更新：2025-12-09
- 作者：后端/DB 团队
- 状态：草稿

## 2. 设计目标与范围
- 目标：支撑 MVP 功能（多兴趣记录、免费 AI 标签、TMDB/Last.fm 集成、时间线/基础统计、简版 RBAC），保证数据一致性、可扩展性与可维护性。
- 范围：核心业务表（photo/movie/music/match_record/tag/user），公共字段规范，索引策略，字段口径。

## 3. 命名规范
- 表名：小写，下划线分隔，业务前缀可选；示例：`photo`、`movie`
- 字段：小写，下划线分隔；布尔 is_xxx；时间 xxx_time；状态/类型使用 tinyint/int+枚举
- 主键：BIGINT，自增
- 公共字段：`creator` `create_time` `updater` `update_time` `deleted`；时间 DATETIME

## 4. 字段类型规范（建议）
- 主键：BIGINT AUTO_INCREMENT
- 金额（无此业务暂不设）
- 状态/类型：TINYINT/INT
- 时间：DATETIME（含时区在应用层处理）；如需精度可用 TIMESTAMP(3)
- 文本：VARCHAR(长度适中，标题 255，URL 512，标签 512)，长文本用 TEXT
- JSON：MySQL 8 JSON（如 EXIF/扩展字段）

## 5. 表设计

### 5.1 用户表 `user`
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT PK | 用户ID |
| email | VARCHAR(128) | 邮箱（可唯一） |
| phone | VARCHAR(32) | 手机（可唯一，若用） |
| password | VARCHAR(128) | 加密密码 |
| nickname | VARCHAR(64) | 昵称 |
| role | TINYINT | 0-用户 1-管理员 |
| status | TINYINT | 1-启用 0-禁用 |
| creator/updater | VARCHAR(64) | |
| create_time/update_time | DATETIME | |
| deleted | TINYINT | 0/1 |
- 索引：uk_email? / uk_phone?；idx_role/status

### 5.2 照片表 `photo`
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT PK |
| user_id | BIGINT | 所属用户 |
| title | VARCHAR(255) | 标题 |
| description | TEXT | 描述 |
| tags | VARCHAR(512) | 标签（逗号分隔） |
| file_url | VARCHAR(512) | 原图地址 |
| thumb_url | VARCHAR(512) | 缩略图地址 |
| exif | JSON | EXIF 数据（time/device/gps） |
| shoot_time | DATETIME | 拍摄时间（解析/用户填） |
| location | VARCHAR(255) | 地点（可选） |
| creator/updater | VARCHAR(64) | |
| create_time/update_time | DATETIME | |
| deleted | TINYINT | 0/1 |
- 索引：idx_user_id, idx_shoot_time, idx_create_time

### 5.3 影视表 `movie`
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT PK |
| user_id | BIGINT | 用户ID |
| tmdb_id | BIGINT | TMDB ID（可空） |
| title | VARCHAR(255) | 标题 |
| type | TINYINT | 1-电影 2-剧集 |
| status | TINYINT | 1-想看 2-在看 3-已看 4-弃剧 |
| rating | DECIMAL(3,1) | 0-10，0.5 步长 |
| genre | VARCHAR(128) | 类型（逗号分隔） |
| tags | VARCHAR(512) | 标签 |
| poster_url | VARCHAR(512) | 海报 |
| overview | TEXT | 简介 |
| release_year | INT | 上映年（可选） |
| creator/updater | VARCHAR(64) | |
| create_time/update_time | DATETIME | |
| deleted | TINYINT | |
- 索引：idx_user_id, idx_status, idx_type, idx_tmdb_id, idx_create_time
- 唯一（可选）：uk_tmdb_user (user_id, tmdb_id) 避免重复

### 5.4 音乐表 `music`
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT PK |
| user_id | BIGINT |
| lastfm_id | VARCHAR(128) | Last.fm ID/mbid（可空） |
| title | VARCHAR(255) |
| artist | VARCHAR(255) |
| album | VARCHAR(255) |
| tags | VARCHAR(512) |
| cover_url | VARCHAR(512) |
| duration | INT | 时长（秒，可选） |
| genre | VARCHAR(128) | 可选 |
| creator/updater | VARCHAR(64) |
| create_time/update_time | DATETIME |
| deleted | TINYINT |
- 索引：idx_user_id, idx_artist, idx_lastfm_id?, idx_create_time
- 唯一（可选）：uk_lastfm_user (user_id, lastfm_id)

### 5.5 球赛记录表 `match_record`
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT PK |
| user_id | BIGINT |
| home_team | VARCHAR(128) |
| away_team | VARCHAR(128) |
| match_time | DATETIME |
| match_type | TINYINT | 1-联赛 2-杯赛 3-友谊赛 |
| watch_type | TINYINT | 1-现场 2-直播 3-回放（可选） |
| home_score | INT | 可空 |
| away_score | INT | 可空 |
| tags | VARCHAR(256) | 可选 |
| notes | TEXT | 可选 |
| creator/updater | VARCHAR(64) |
| create_time/update_time | DATETIME |
| deleted | TINYINT |
- 索引：idx_user_id, idx_match_time, idx_match_type

### 5.6 标签表 `tag`（可选，通用标签）
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT PK |
| user_id | BIGINT |
| tag_name | VARCHAR(64) |
| tag_type | VARCHAR(32) | photo/movie/music/match |
| color | VARCHAR(16) | 可选 |
| creator/updater | VARCHAR(64) |
| create_time/update_time | DATETIME |
| deleted | TINYINT |
- 索引：idx_user_id, idx_tag_type, uk_user_tag_type (user_id, tag_name, tag_type)

## 6. 索引策略
- 必须：主键、外键/关联 ID（user_id）、时间（create_time/shoot_time/match_time）、状态/类型字段
- 可选唯一：tmdb_id/lastfm_id 与 user_id 组合，避免重复创建
- 查询场景驱动：分页列表用 create_time/shoot_time；搜索/过滤用 status/type/tag/genre/artist

## 7. 约束与校验
- 字段必填：user_id、标题（可默认生成）、时间（记录时间/拍摄时间/比赛时间）
- 长度限制：标题 255，标签 512，URL 512
- 状态/类型枚举校验
- 评分范围与步长（0-10，0.5）
- 文件信息不直接入库（存 URL/路径）

## 8. 数据安全与合规
- 不存储明文密码（User 表密码需加密）
- 敏感配置不入库（API Key 等）
- 用户隔离：所有业务表按 user_id 过滤
- 软删：deleted 字段，默认过滤

## 9. 数据生命周期与备份（MVP 占位）
- 软删保留；未做自动清理（后续可加归档策略）
- 备份：每日全量/增量（占位）；恢复流程后续完善

## 10. 数据字典（摘要示例）
- `photo.tags`：逗号分隔；AI 生成或用户输入
- `movie.status`：1 想看 / 2 在看 / 3 已看 / 4 弃剧
- `match_record.match_type`：1 联赛 / 2 杯赛 / 3 友谊赛
- `match_record.watch_type`：1 现场 / 2 直播 / 3 回放

## 11. 变更与版本
- 变更需记录：字段/索引/约束变化；影响范围；迁移脚本
- 版本按 vX.Y.Z 递增；保留历史 DDL 变更记录

## 12. 风险与对策
- 数据重复：tmdb_id/lastfm_id 唯一约束（可选）；创建前先查重
- 性能：合理索引；大字段避免频繁查询；分页使用覆盖索引
- 配额/外部依赖：数据回填失败允许手动；缓存外部返回
- 扩展性：预留 JSON 扩展字段（exif/attributes）；标签表通用化


