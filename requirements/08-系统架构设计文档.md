# 系统架构设计文档（SAD）

## 1. 文档信息
- 文档名称：系统架构设计文档（SAD）
- 版本号：v1.0.0
- 创建日期：2025-12-09
- 最后更新：2025-12-09
- 作者：架构/技术团队
- 状态：草稿

## 2. 目标与范围
- 目标：为 MVP 提供清晰的系统架构设计，支撑多兴趣记录、免费 AI 自动标签、第三方数据源集成、时间线/基础统计、简版 RBAC 与日志/健康检查。
- 范围：后端整体架构、模块划分、数据与接口、AI/第三方集成、非功能（性能/可用性/安全/运维）设计。

## 3. 架构概览
- 架构风格：单体应用（MVP）+ 分层架构
- 分层：API (Controller) / Service / Manager / Repository (Mapper) / Domain (DO) / Infra (Config, Client) / Web (Filter/Exception)
- 模块：`interest-tracker-api`（契约）、`interest-tracker-server`（实现）
- 技术栈：Java 22、Spring Boot 3.3.x、MyBatis-Plus、MySQL、Redis、Swagger、Lombok
- AI：免费优先（Hugging Face/Gemini）；OpenAI 为备选，默认关闭
- 数据源：TMDB（影视）、Last.fm（音乐）；本地上传 + EXIF 解析；球赛手动录入（MVP）
- 部署：单节点为主，预留容器化；支持 profile 配置

### 3.1 总体架构图（MVP，ASCII）
```
┌─────────────────────────────────────────────────────┐
│                     前端（Web）                      │
│  Vue3（占位） / Axios / Swagger-UI                   │
└──────────────────────────┬──────────────────────────┘
                           │ HTTP/JSON (REST)
┌──────────────────────────▼──────────────────────────┐
│               Backend（Spring Boot）                │
│  - Controller (API)                                 │
│  - Service / Manager                                │
│  - Infra:                                           │
│      • Clients: TMDB / Last.fm / HF / Gemini / OpenAI│
│      • Config / Security / Exception                │
│  - Repository (MyBatis-Plus)                        │
│  - Domain (DO/VO)                                   │
└───────────────┬───────────────┬───────────────┬────┘
                │               │               │
                │               │               │
        ┌───────▼───────┐ ┌─────▼──────┐ ┌─────▼──────┐
        │   MySQL       │ │   Redis    │ │ ObjectStore│
        │  (数据存储)    │ │(缓存/会话*) │ │(本地/MinIO*)│
        └───────────────┘ └────────────┘ └────────────┘
             *MVP 可选，按需要开启
```

### 3.2 模块关系图（逻辑）
```
api (契约/错误码/DTO)
     ▲
     │
server (实现)
  ├─ controller -> service -> manager -> mapper
  ├─ clients (TMDB/Last.fm/HF/Gemini/OpenAI)
  ├─ config (db/mybatis/swagger/security)
  └─ framework (common/web/mybatis)
```

### 3.3 典型调用链
```
前端 -> Controller -> Service -> Manager(可选) -> Client/Mapper
      -> 外部API (TMDB/Last.fm/AI) 或 MySQL
      -> 返回统一 CommonResult
```

## 4. 模块与包结构（server）
```
com.interest.tracker
├── framework
│   ├── common (pojo/exception/util)
│   ├── mybatis (config/dataobject/mapper/query)
│   └── web (controller/handler/util)
└── module (预留业务子域)
    ├── photo
    ├── movie
    ├── music
    ├── match
    └── tag (通用标签，可选)
```
- API 模块：定义错误码/常量/DTO（扩展时）
- Server 模块：实现 Controller/Service/Mapper/Config/Client

## 5. 关键组件设计
- Controller：RESTful API，参数校验，调用 Service，统一返回 CommonResult
- Service：业务逻辑编排；事务控制；依赖 Manager/Mapper
- Manager（可选）：封装与外部服务/复杂组合逻辑
- Mapper：MyBatis-Plus，DO 映射，分页/条件查询
- Client：第三方/AI 客户端（TMDBClient、LastFmClient、HuggingFaceClient、GeminiClient、OpenAIClient）
- Config：数据源、MyBatis-Plus、Swagger、Cors、AI/第三方配置
- Exception：全局异常处理，错误码

## 6. 数据设计概览（MVP）
- 主要表（与数据库设计文档对齐）：
  - `photo`：照片基本信息、EXIF、文件链接、标签
  - `movie`：影视信息、tmdb_id、状态/评分/标签
  - `music`：音乐信息、lastfm_id、标签
  - `match_record`：球赛记录（手动）
  - `tag`：通用标签（可选）
  - `user`：用户账号
- 公共字段：id (BIGINT)、creator/ create_time / updater / update_time / deleted；时间字段 DATETIME
- 索引：主键、常用过滤字段（user_id、time、status）、外键/第三方 ID 索引

## 7. 外部服务与集成
- TMDB：影视搜索/详情；缓存搜索结果；失败兜底手动创建
- Last.fm：音乐搜索/详情；缓存结果
- AI（免费优先）：Hugging Face / Gemini；统一调用封装；超时/重试/缓存/降级
- AI（付费备选）：OpenAI 默认关闭；需开关与限额
- 对象存储：MVP 可本地；预留 MinIO/OSS

## 8. 配置与环境
- 配置文件：application.yml + profile（dev/prod）
- 环境变量：API Keys（TMDB/LASTFM/HF/GEMINI/OPENAI）、DB/Redis/OSS
- 日志级别：prod INFO，debug 仅限开发
- CORS：按前端域名白名单（占位）

## 9. 安全与权限
- 鉴权：JWT/Token；登录后访问受限接口
- 权限：简版 RBAC（用户/管理员）；用户仅操作自身数据，管理员可全量
- 输入校验：后端参数校验；文件类型/大小校验
- 数据安全：不返回敏感字段；密码加密；配置脱敏；HTTPS（上线要求）
- 速率限制：可选简易限流（接口级，后续细化）

## 10. 非功能设计
- 性能：MVP 核心接口 P95 < 800ms（低并发/小数据量）；后续 < 500ms
- 可用性：SLA 99.5%（单区单活）；/health 探活；可选简易熔断/重试
- 隐私：图片/位置信息仅用户可见；支持导出/删除（设计占位）
- 可靠性：关键操作事务回滚；外部调用超时/重试；降级策略
- 监控/日志：访问/错误日志；健康检查；基础指标（QPS、错误率、响应时间）占位；可选告警

## 11. 缓存与降级
- 缓存：Redis 用于 TMDB/Last.fm 搜索结果、AI 生成结果；Key 包含入参/哈希；TTL 可配置（搜索 ~1h，AI ~24h）
- 降级：免费 AI 失败 → 重试 → 手动输入；付费 AI 默认关；数据源失败允许手动录入
- 幂等：外部调用注意重试幂等性；上传/创建接口需避免重复提交（前端/后端侧可选 Token/幂等键）

## 12. 日志与监控
- 日志：访问、错误、慢查（可选）；不记录敏感信息；建议 JSON 便于采集
- 健康检查：/actuator/health（或自定义）
- 指标（占位）：QPS、错误率、响应时间；AI 调用成功率/失败数；外部调用失败数

## 13. 部署与交付（MVP）
- 单节点部署即可；预留容器化（Dockerfile）与多环境配置
- 数据库初始化：执行 init.sql；准备 API Keys；配置存储路径
- 备份：数据库备份策略占位；对象存储文件保留策略

## 14. 风险与对策
- 配额/稳定性：多提供方 + 缓存 + 降级；必要时人工开关/切换
- 成本：付费 AI 默认关；缓存减少调用；限额配置
- 隐私/合规：最小化收集；支持删除/导出占位；遵守第三方条款
- 进度：MVP 范围控制，Must 优先；架构预留扩展但不超范围

## 15. 验收与变更
- 验收（技术向）：性能/错误率/鉴权/越权/AI 成功率/健康检查/日志可用
- 变更：记录原因/影响；评审（PM/Tech/QA）；版本递增 vX.Y.Z


