# 接口需求文档（IRD）

## 1. 文档信息
- 文档名称：接口需求文档（IRD）
- 版本号：v1.0.0
- 创建日期：2025-12-09
- 最后更新：2025-12-09
- 作者：产品/技术团队
- 状态：草稿

## 2. 目的与范围
- 目的：定义 MVP 阶段对外 RESTful 接口的契约，确保前后端/测试/运维对齐。
- 范围：账号与鉴权、摄影/影视/音乐/球赛记录、搜索（TMDB/Last.fm）、AI 标签、时间线/统计、健康检查。

## 3. 接口规范
- 协议：HTTPS（生产），HTTP（开发）
- 风格：RESTful，资源名用复数 `/api/photos` 等
- 版本：当前 /api，后续可加 `/api/v1`
- 编码：UTF-8，JSON
- 鉴权：Bearer Token（JWT）；登录/注册开放，其他需鉴权；管理员接口需角色校验
- 错误码：统一 `CommonResult`，`code`/`msg`/`data`；业务码集中管理（见错误码表占位）
- 幂等：写接口建议前端防重复提交；外部调用（AI/搜索）服务器侧有超时/重试
- 限流（占位）：可按 IP/用户简单限流，生产按需开启
- 分页：`pageNo`（1 起）、`pageSize`；返回 `total`/`list`
- 时间：ISO8601 字符串或 `yyyy-MM-dd HH:mm:ss`
- 上传：Multipart，字段 `file`

## 4. 通用响应结构
```json
{
  "code": 0,
  "msg": "ok",
  "data": {}
}
```

## 5. 认证与用户
### 5.1 注册
- POST `/api/auth/register`
- body: `{ "email": "", "password": "", "nickname": "" }` （或手机号）
- resp: `data: { "userId": 1 }`

### 5.2 登录
- POST `/api/auth/login`
- body: `{ "email": "", "password": "" }`
- resp: `data: { "token": "Bearer xxx", "expiresIn": 3600 }`

### 5.3 登出
- POST `/api/auth/logout`
- header: Authorization
- resp: ok

## 6. 摄影（Photo）
### 6.1 上传照片
- POST `/api/photos`
- form-data: `file` (JPG/PNG ≤10MB), `title?`, `description?`, `tags?` (csv), `shootTime?`, `location?`
- resp: `data: { id, url, thumbUrl, exif:{time,device,gps}, tags:[] }`

### 6.2 获取详情
- GET `/api/photos/{id}`

### 6.3 列表/分页
- GET `/api/photos`
- query: `pageNo,pageSize,tag?,startTime?,endTime?,sort=ctime|shootTime`

### 6.4 更新
- PUT `/api/photos/{id}`
- body: `{ title?, description?, tags?, shootTime?, location? }`

### 6.5 删除
- DELETE `/api/photos/{id}`

### 6.6 重新生成标签（AI，免费优先）
- POST `/api/photos/{id}/ai-tags`
- resp: `data: { tags: [] }`
- 行为：调用 HF/Gemini；失败返回错误码并提示可手动

## 7. 影视（Movie）
### 7.1 搜索（TMDB）
- GET `/api/movies/search`
- query: `keyword`, `page?`
- resp: TMDB 精简结果列表（含 tmdbId, title, year, posterUrl, overview）

### 7.2 创建
- POST `/api/movies`
- body: `{ tmdbId?, title, type, status?, rating?, tags?, posterUrl?, overview? }`
- 说明：tmdbId 可空（手动）；rating 0.5 颗粒度

### 7.3 详情
- GET `/api/movies/{id}`

### 7.4 列表/分页
- GET `/api/movies`
- query: `pageNo,pageSize,status?,type?,tag?,keyword?,sort=ctime|rating|time`

### 7.5 更新/删除
- PUT `/api/movies/{id}` / DELETE `/api/movies/{id}`

### 7.6 生成标签（AI）
- POST `/api/movies/{id}/ai-tags`

## 8. 音乐（Music）
### 8.1 搜索（Last.fm）
- GET `/api/musics/search`
- query: `keyword`, `page?`
- resp: 精简结果（lastfmId/mbid, title, artist, album, coverUrl）

### 8.2 创建
- POST `/api/musics`
- body: `{ lastfmId?, title, artist, album?, tags?, coverUrl? }`

### 8.3 详情/列表/更新/删除
- GET `/api/musics/{id}`
- GET `/api/musics?query...`
- PUT `/api/musics/{id}` / DELETE `/api/musics/{id}`

### 8.4 生成标签（AI）
- POST `/api/musics/{id}/ai-tags`

## 9. 球赛（Match，简版）
- POST `/api/matches`  `{ homeTeam, awayTeam, matchTime, matchType, score? }`
- GET `/api/matches/{id}`
- GET `/api/matches?pageNo&pageSize&matchType?&startTime?&endTime?`
- PUT `/api/matches/{id}` / DELETE `/api/matches/{id}`

## 10. 时间线与统计
### 10.1 时间线
- GET `/api/timeline`
- query: `type=photo|movie|music|match|all`, `startTime?`, `endTime?`, `tag?`
- resp: 按时间聚合的记录列表

### 10.2 基础统计卡片
- GET `/api/stats/summary`
- resp 示例：
```json
{
  "photoCount": 10,
  "movieCount": 5,
  "musicCount": 8,
  "matchCount": 2,
  "weeklyCounts": [...],
  "typeRatio": { "photo":0.5,"movie":0.2,"music":0.2,"match":0.1 }
}
```

## 11. 智能推荐（可选/扩展，默认依赖免费 AI 文案）
- GET `/api/recommend/movies`
  - query: `limit?`（默认5）
  - resp: `[ { movieId?, title, reason, posterUrl } ]`
- GET `/api/recommend/musics`
  - resp: `[ { musicId?, title, artist, reason, coverUrl } ]`
- GET `/api/recommend/photos`
  - resp: `[ { photoId?, title, reason, thumbUrl } ]`
- 说明：推荐策略可基于内容/标签/评分 + AI 生成推荐理由；若推荐服务未开启返回空列表或提示

## 12. 总结与报告（可选/扩展）
### 12.1 月度总结
- GET `/api/summary/monthly`
- query: `month=YYYY-MM`（默认当月）
- resp 示例：
```json
{
  "month": "2025-12",
  "counts": { "photo": 10, "movie": 5, "music": 8, "match": 2 },
  "topTags": ["旅行","动作","摇滚"],
  "highlights": ["本月拍照最多的一天是 ...", "你最常看的类型是 ..."],
  "aiSummary": "本月你偏好 ... （可选，AI 生成）"
}
```

### 12.2 周度总结
- GET `/api/summary/weekly`
- query: `week=YYYY-Www`（ISO 周，默认本周）
- resp 同月度，字段 week 替代 month

### 12.3 年度/自定义总结（占位）
- GET `/api/summary/yearly`
- query: `year=YYYY`
- resp：结构同月度/周度，增加年度维度；可包含 AI 文案

## 13. 健康检查
- GET `/api/health` 或 `/actuator/health`
- resp: `{"status":"UP"}`

## 14. 鉴权与权限
- 所有 `/api/**` 除登录/注册/健康检查外需 Authorization: Bearer <token>
- 管理员接口（如全量列表/管理他人数据）需角色校验（后端鉴权）
- 越权请求返回 403，未登录返回 401

## 15. 错误码（占位示例）
- 0：成功
- 401：未登录或 Token 失效
- 403：无权限
- 4001：参数校验失败
- 4101：文件类型/大小不支持
- 4201：外部服务调用失败（TMDB/Last.fm/AI）
- 4301：AI 生成失败（可重试/手动）
- 5000：系统异常

## 16. 安全与限流要求
- HTTPS（生产）、JWT 鉴权、越权校验
- 上传校验：类型/大小
- 速率限制：可选按 IP/用户简单限流，防刷（占位）
- 日志脱敏：不记录密码/Token/敏感信息

## 17. 性能与超时
- API 超时（外部）：AI/搜索调用设置超时（占位 3-5s）
- P95 目标：核心接口 < 800ms（MVP 数据量）

## 18. 兼容性与版本
- 当前版本 `/api`；若接口有破坏性变更，新增 `/api/v1` 版本

## 19. 变更记录
- v1.0.0：首版定义 MVP 接口

