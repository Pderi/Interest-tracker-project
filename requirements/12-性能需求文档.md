# 性能需求文档（Performance Requirements）

## 1. 文档信息
- 文档名称：性能需求文档
- 版本号：v1.0.0
- 创建日期：2025-12-09
- 最后更新：2025-12-09
- 作者：技术团队
- 状态：草稿

## 2. 目标与范围
- 目标：定义 MVP 阶段性能目标、场景、指标、容量假设与测试要求，确保关键路径满足体验。
- 范围：后端 REST 接口（上传/搜索/创建/列表/时间线/统计）、外部调用（TMDB/Last.fm/AI）。

## 3. 性能目标（SLO/SLA/Budget）
- SLO（服务器侧，MVP 数据量）：
  - 核心接口（查询/创建）P95 < 800ms；P99 < 1200ms
  - 上传（≤10MB）服务器侧处理 < 2000ms（不含用户上行）
  - 外部调用（AI/搜索）超时：3-5s，可配置；超时需降级
- 错误率：核心接口 HTTP 5xx < 0.5%；外部调用失败率 < 3%（超限需告警）
- 可用性：SLA 99.5%（与可用性文档对齐）
- 资源预算（单节点，占位值，后续压测校准）：
  - CPU 平均 < 60%，内存 < 70%，线程池拒绝率 = 0
  - DB 连接池等待 < 50ms（P95）
- 并发/容量假设（MVP 可调整）：峰值 QPS 50-100；日活 1k，日新增记录 < 10k，日图片 < 10GB

## 4. 关键场景
- 上传照片：上传+存储+EXIF+AI 标签
- 搜索/创建影视（TMDB）、音乐（Last.fm）
- 列表/时间线查询（过滤/排序）
- 基础统计卡片（实时/简易聚合）
- AI 标签生成（照片/影视/音乐）——默认免费 API

## 5. 性能指标口径
- 响应时间：服务端处理时间（不含网络上传），P50/P90/P95
- 吞吐：QPS/TPS
- 资源：CPU/内存/磁盘 I/O/带宽（服务器侧）
- 失败率：HTTP 5xx / 业务错误码（含外部失败）
- 外部依赖：TMDB/Last.fm/AI 调用成功率与耗时
- 队列/线程池：活跃线程、排队长度、拒绝次数（如使用）

## 6. 性能设计与策略
- 缓存：外部搜索结果（TMDB/Last.fm）、AI 结果（24h），减少重复调用
- 索引：user_id、时间字段、状态/类型、第三方 ID；分页优先覆盖索引
- 连接池/线程池：合理配置池大小、超时、排队策略，拒绝需日志告警
- 限流/超时：外部调用超时 3-5s；必要时对外部调用限流以防放大
- 重试与降级：外部失败有限次重试；失败提示手动输入/关闭 AI
- 上传：限制大小/类型；缩略图/压缩可异步，避免阻塞请求线程
- 统计：基础统计可在线聚合，小数据量直接 SQL；大数据量可预计算（后续）

## 7. 压测要求（MVP）
- 场景：上传、列表查询（含过滤/排序）、时间线、搜索 TMDB/Last.fm、AI 标签（可模拟/打桩）
- 目标：P95<800ms；错误率<0.5%；外部调用超时可兜底
- 数据量：模拟日新增 10k，存量 100k 以内；图片可用占位文件
- 工具：JMeter/k6；环境与生产配置接近（CPU/内存/DB 规格相似）
- 关注：线程池/连接池等待、GC、DB 慢查询、外部调用耗时

## 8. 监控与告警（性能相关）
- 指标：QPS、响应时间分位、错误率、外部依赖失败率、线程池/连接池使用率
- 告警（建议阈值占位）：
  - 核心接口 P95 > 1.2s（持续 5 分钟）
  - 5xx > 0.5%（持续 5 分钟）
  - 外部调用失败率 > 5%（持续 5 分钟）
  - 线程池拒绝/连接池等待异常升高

## 9. 变更与版本
- 若业务量/并发显著提升，需更新容量假设与目标
- 版本记录：v1.0.0 首版定义

