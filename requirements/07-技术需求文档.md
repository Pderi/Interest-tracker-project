# 技术需求文档（TRD）

## 1. 文档信息
- 文档名称：技术需求文档（TRD）
- 版本号：v1.0.0
- 创建日期：2025-12-09
- 最后更新：2025-12-09
- 作者：技术团队
- 状态：草稿

## 2. 文档目的
- 将业务/产品需求转化为可实施的技术要求，覆盖架构、技术栈、接口、数据、安全、非功能、运维与交付要求。
- 与 PRD/BRD/IRD/架构文档形成一致的技术基线。

## 3. 范围与优先级
- 本期范围（MVP）：多兴趣统一记录（摄影/影视/音乐/球赛简版）、免费 AI 自动标签、TMDB/Last.fm 集成、时间线/基础统计、简版 RBAC、日志/健康检查。
- 优先级：Must（MVP 必须交付）、Should（MVP+）、Could（后续）。

## 4. 技术栈与基础设施
- 后端：Java 22，Spring Boot 3.3.x，MyBatis-Plus，Maven
- 数据库：MySQL 8.x
- 缓存：Redis（API 结果、AI 缓存、会话/限流可选）
- 对象存储：本地/MinIO/OSS（三选一，MVP 可本地）
- 前端（占位）：Vue 3 + Axios（不在本 TRD 详述）
- AI：免费优先（Hugging Face Inference API、Google Gemini），付费备选（OpenAI，默认关闭）
- 接口文档：Springdoc/Swagger
- 部署：单节点优先（MVP），支持容器化占位

## 5. 架构与模块要求（概要）
- 分层：Controller / Service / Mapper / DO / VO / Config / Util
- 模块：api（契约）与 server（实现）已拆分；保持包结构规范（见架构规范文档）
- 配置隔离：application.yml + profile（dev/prod），敏感信息用环境变量
- 可扩展性：预留新兴趣域/新数据源扩展点；AI 提供者可配置/切换

## 6. 外部集成要求
- 影视：TMDB API（必需），搜索结果缓存；失败提示手动创建
- 音乐：Last.fm API（必需），搜索结果缓存；失败提示手动创建
- AI（免费优先）：Hugging Face / Gemini；统一客户端封装，支持超时/重试/降级；结果缓存
- AI（付费备选）：OpenAI，默认关闭；需开关与限额
- 未来可选：对象存储服务（MinIO/OSS），队列/任务（若需异步扩展）

## 7. 数据模型与存储要求（概要）
- 核心表（示例）：photo、movie、music、match_record、tag、user
- 字段要求：公共字段（creator, create_time, updater, update_time, deleted）；主键 BIGINT；时间字段 DATETIME
- 约束：必要索引（主键、时间、外键/关联 ID、常用查询字段）；唯一键（如 tmdb_id/lastfm_id 可选）
- 数据字典与 ER 图：详见 DDD 文档/数据库设计文档

## 8. 接口与契约
- API 规范：RESTful，统一返回 CommonResult，错误码集中管理
- 接口文档：Swagger/OpenAPI 生成；字段/类型/必填/错误码
- 版本管理：/api/**，后续若有版本迭代加 /v1 前缀（占位）

## 9. 非功能要求
- 性能（MVP 数据量，低并发）：核心接口 P95 < 800ms；后续优化目标 < 500ms
- 可用性：SLA 99.5%（单区单活）；健康检查接口；支持基础熔断/限流占位
- 安全：HTTPS（上线要求）；鉴权/越权校验；最小化返回敏感字段；基础速率限制（可选）
- 隐私：图片/位置信息仅用户可见；敏感配置不入库；支持数据删除/导出（设计占位）
- 可靠性：关键操作异常回滚；接口错误率可监控
- 监控与日志：访问日志/错误日志；健康检查；基础指标（QPS、错误率、响应时间）占位；可选简易告警

## 10. 配置与开关
- 外部 API Key：TMDB、Last.fm、Hugging Face、Gemini、OpenAI（可空）；全部通过环境变量注入
- AI 开关：全局开关 + 按功能开关（照片标签/影视标签/音乐标签）；默认免费方案开启，付费方案关闭
- 成本/配额控制：AI 调用限额（占位数值），结果缓存（搜索 1h，AI 24h 可配置）
- 日志级别：prod 默认 INFO；debug 仅限开发/排障

## 11. 缓存与降级
- 缓存：外部搜索结果、AI 生成结果；可用 Redis，Key 需含入参/哈希
- 降级策略：免费 API 失败 → 重试 → 手动输入兜底；付费 API 需显式开关
- 幂等/重试：外部调用需超时/重试策略；重试次数/超时可配置

## 12. 安全与合规
- 鉴权：JWT/Session；接口需鉴权，越权检查
- 输入校验：后端参数校验，文件类型/大小校验
- 数据安全：不返回敏感字段；密码加密存储；配置脱敏
- 第三方合规：遵守 TMDB/Last.fm/AI API 使用条款与配额限制

## 13. 部署与运维（MVP）
- 部署：单节点可行；保留容器化/多环境的配置占位
- 健康检查：/actuator/health（或自定义），用于探活
- 日志：文件/控制台均可；建议 JSON/可被采集
- 备份：数据库备份策略（占位）；对象存储数据保留

## 14. 质量与验收（技术向）
- 功能：Must 需求接口用例通过率 100%；Should ≥90%
- 性能：核心接口 P95 < 800ms（MVP 数据量）
- 稳定性：核心接口错误率 < 0.5%
- 安全：鉴权/越权/基本限流用例通过
- AI：自动标签成功率（有可用标签）≥90%，失败有兜底提示
- 监控：健康检查可用；关键日志可查询

## 15. 风险与对策
- 配额/稳定性：多提供方（免费优先）+ 缓存 + 降级 + 重试
- 成本：付费 AI 默认关闭；限额与开关；缓存减少调用
- 隐私/合规：最小化收集，支持删除/导出占位；遵守第三方条款
- 进度：MVP Must/Should 分层，严格控制范围

## 16. 变更管理
- 变更需记录：原因、影响范围、优先级调整
- 评审：PM/Tech/QA 共同评审后生效
- 版本：按 vX.Y.Z 递增，保留历史


