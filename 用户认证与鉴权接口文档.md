# 用户认证与鉴权接口文档（后端）

> 项目：兴趣足迹 (Interest Tracker)  
> 模块：用户登录与鉴权  
> 基础地址：`http://localhost:8080`

---

## 一、通用说明

- **接口前缀**：所有接口均为 RESTful 风格。
- **统一响应结构**：均使用 `CommonResult<T>` 包装：

```json
{
  "code": 0,
  "data": {},
  "msg": "成功"
}
```

- **认证方式**：登录后，前端需要在请求头中携带：

```http
Authorization: Bearer <JWT_TOKEN>
```

- **错误码**：
  - 全局错误码见 `GlobalErrorCodeConstants`
  - 用户 & 鉴权相关错误码见 `UserErrorCodeConstants`

---

## 二、用户注册接口

- **接口地址**：`POST /api/user/register`
- **功能说明**：创建新用户（注册），默认启用状态。
- **是否需要登录**：否

### 2.1 请求体

`Content-Type: application/json`

```json
{
  "username": "test_user",
  "password": "123456",
  "nickname": "测试用户",
  "email": "test@example.com",
  "phone": "13800000000"
}
```

字段说明：

- `username`：string，必填，最长 64，唯一。
- `password`：string，必填，长度 6~64，明文传输，后端使用 BCrypt 加密存储。
- `nickname`：string，可选，最长 64。
- `email`：string，可选，最长 128，邮箱格式，唯一（非空时校验）。
- `phone`：string，可选，最长 32。

### 2.2 响应示例

```json
{
  "code": 0,
  "data": 10001,
  "msg": "成功"
}
```

其中 `data` 为新创建用户的 `id`（Long）。

### 2.3 可能的错误码

- `USER_USERNAME_EXISTS`：用户名已存在。
- `USER_EMAIL_EXISTS`：邮箱已存在。
- 其它参数校验错误会返回 400 相关错误信息。  

---

## 三、用户登录接口

- **接口地址**：`POST /api/user/login`
- **功能说明**：用户名 + 密码登录，返回 JWT Token。
- **是否需要登录**：否

### 3.1 请求体

```json
{
  "username": "test_user",
  "password": "123456"
}
```

字段说明：

- `username`：string，必填。
- `password`：string，必填。

### 3.2 响应示例

```json
{
  "code": 0,
  "data": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9....",
  "msg": "成功"
}
```

其中 `data` 为后端签发的 JWT Token 字符串。

### 3.3 可能的错误码

- `USER_PASSWORD_ERROR`：用户名或密码错误。
- `USER_DISABLED`：用户已被禁用。

---

## 四、获取当前登录用户信息

- **接口地址**：`GET /api/user/info`
- **功能说明**：根据当前请求中的 Token 获取用户基本信息。
- **是否需要登录**：是（需要在请求头携带 `Authorization: Bearer <token>`）

### 4.1 请求参数

无额外参数，仅需在 Header 携带 Token。  

示例：

```http
GET /api/user/info HTTP/1.1
Host: localhost:8080
Authorization: Bearer <JWT_TOKEN>
```

### 4.2 响应示例

```json
{
  "code": 0,
  "data": {
    "id": 10001,
    "username": "test_user",
    "nickname": "测试用户",
    "avatar": "https://example.com/avatar.png",
    "email": "test@example.com",
    "phone": "13800000000",
    "status": 1,
    "createTime": "2025-12-18 12:00:00"
  },
  "msg": "成功"
}
```

### 4.3 可能的错误码

- `401`（`UNAUTHORIZED`）：未登录或 Token 无效（当前实现中，当 `UserContext` 中没有用户 ID 时，直接返回 401）。
- `USER_NOT_EXISTS`：Token 中的用户 ID 在数据库中不存在（极端情况，如用户被物理删除）。
- `USER_DISABLED`：用户被禁用。  

---

## 五、刷新 Token 接口

- **接口地址**：`POST /api/user/refresh-token`
- **功能说明**：在当前登录态有效的前提下，根据当前用户重新签发一个新的 JWT Token。
- **是否需要登录**：是

### 5.1 请求参数

无请求体，仅需在 Header 携带 Token：

```http
POST /api/user/refresh-token HTTP/1.1
Host: localhost:8080
Authorization: Bearer <JWT_TOKEN>
Content-Length: 0
```

### 5.2 响应示例

```json
{
  "code": 0,
  "data": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9....",
  "msg": "成功"
}
```

### 5.3 刷新策略说明

- 当前实现为 **同一个 Token 的续期**：
  - 请求必须带着一个仍然 **有效** 的旧 Token。
  - 后端从 Token 中解析出用户 ID（在拦截器中写入 `UserContext`）。
  - Service 层再次校验用户是否存在、是否启用。
  - 然后重新调用 `JwtUtils.generateToken(userId, username)` 生成一个新的 Token。
- **没有单独实现 refresh_token 双 Token 机制**，如果后续需要更安全的双 Token 模式（access_token + refresh_token），可以在此基础上扩展。

### 5.4 可能的错误码

- `401`（`UNAUTHORIZED`）：未携带 Token 或 Token 无法解析出用户 ID。
- `AUTH_TOKEN_INVALID`：Token 非法或被篡改。
- `AUTH_TOKEN_EXPIRED`：Token 过期。
- `USER_NOT_EXISTS`：Token 中的用户已不存在。
- `USER_DISABLED`：用户已被禁用。

---

## 六、JWT 配置说明

JWT 相关配置通过 `application.yml` / `application-dev.yml` 以及 `SecurityConfig` 进行管理：

- **配置项**（默认值）：

```yaml
jwt:
  secret: interest-tracker-default-secret  # 签名密钥，建议在生产环境中通过环境变量覆盖
  expire-seconds: 604800                  # Token 过期时间，单位秒，默认 7 天
```

- **拦截路径**：在 `SecurityConfig` 中配置 `JwtAuthInterceptor`：
  - 拦截：`/api/**`
  - 放行：
    - `/api/test/**`
    - `/api/user/login`
    - `/api/user/register`
    - `/v3/api-docs/**`
    - `/swagger-ui.html`
    - `/swagger-ui/**`

---

## 七、前端对接建议（简要）

- 登录成功后：
  - 将返回的 `token` 持久化（如 `localStorage` 或 `sessionStorage`）。
  - 所有需要登录的接口，在请求头添加 `Authorization: Bearer <token>`。
- 刷新 Token：
  - 可以在前端维护一个定时任务，在 Token 即将过期前调用 `/api/user/refresh-token`，替换本地的 Token。
  - 或者在收到后端返回的 Token 过期错误码时，触发刷新逻辑（视需求和安全策略而定）。
- 登出：
  - 前端清空本地存储的 Token 即可（当前后端未实现服务器端会话，完全基于 JWT）。

---

> 如后续增加角色权限、管理端用户接口等，可以在此文档基础上扩展新的章节（例如：角色管理接口、权限拦截规则等）。


